<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0c8778">
  <meta name="description" content="Screening & In-Depth Interviews - UHAS-HPI Research">
  <title>UHAS Toolkit A - Offline Research Tool</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./assets/css/main.css">
  <link rel="stylesheet" href="./vendor/bootstrap-icons/bootstrap-icons.min.css">
  <link rel="manifest" href="./manifest.json">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="./assets/icons/icon-192.svg">

  <style>
    /* Toolkit-specific styles */
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-md);
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 480px) {
      .grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .nav-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      text-align: center;
      text-decoration: none;
      transition: all var(--transition);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80px;
    }

    .nav-card:hover {
      transform: translateY(-3px);
      border-color: var(--primary);
      box-shadow: var(--shadow-md);
    }

    .nav-card.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .nav-card.active h3,
    .nav-card.active .card-icon {
      color: white;
    }

    .nav-card h3 {
      font-size: 0.85rem;
      margin-top: var(--space-xs);
      margin-bottom: 0;
      color: var(--text);
    }

    .nav-card .card-icon {
      font-size: 1.5rem;
      color: var(--primary);
    }

    /* Content Sections */
    .content-section {
      display: none;
      animation: fadeIn 0.3s ease-in-out;
    }

    .content-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .content-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--space-lg);
    }

    .metric-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
    }

    .metric-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    /* Row/Grid Utilities */
    .row {
      display: flex;
      flex-wrap: wrap;
      margin: 0 -0.5rem;
    }

    .row>* {
      padding: 0 0.5rem;
      box-sizing: border-box;
    }

    .col-6 {
      flex: 0 0 50%;
      max-width: 50%;
    }

    .col-md-3 {
      flex: 0 0 25%;
      max-width: 25%;
    }

    .col-md-4 {
      flex: 0 0 33.333%;
      max-width: 33.333%;
    }

    .col-md-5 {
      flex: 0 0 41.666%;
      max-width: 41.666%;
    }

    .col-md-6 {
      flex: 0 0 50%;
      max-width: 50%;
    }

    .col-md-7 {
      flex: 0 0 58.333%;
      max-width: 58.333%;
    }

    .col-md-8 {
      flex: 0 0 66.666%;
      max-width: 66.666%;
    }

    .col-lg-3 {
      flex: 0 0 25%;
      max-width: 25%;
    }

    .col-lg-4 {
      flex: 0 0 33.333%;
      max-width: 33.333%;
    }

    .col-lg-5 {
      flex: 0 0 41.666%;
      max-width: 41.666%;
    }

    .col-lg-6 {
      flex: 0 0 50%;
      max-width: 50%;
    }

    .col-lg-7 {
      flex: 0 0 58.333%;
      max-width: 58.333%;
    }

    .col-lg-8 {
      flex: 0 0 66.666%;
      max-width: 66.666%;
    }

    .col-lg-9 {
      flex: 0 0 75%;
      max-width: 75%;
    }

    .col-12 {
      flex: 0 0 100%;
      max-width: 100%;
    }

    .g-3 {
      gap: var(--space-md);
    }

    .g-4 {
      gap: var(--space-lg);
    }

    .mx-auto {
      margin-left: auto;
      margin-right: auto;
    }

    @media (max-width: 768px) {

      .col-md-3,
      .col-md-4,
      .col-md-5,
      .col-md-6,
      .col-md-7,
      .col-md-8 {
        flex: 0 0 100%;
        max-width: 100%;
      }
    }

    @media (max-width: 992px) {

      .col-lg-3,
      .col-lg-4,
      .col-lg-5,
      .col-lg-6,
      .col-lg-7,
      .col-lg-8,
      .col-lg-9 {
        flex: 0 0 100%;
        max-width: 100%;
      }
    }

    /* Desktop centered layout */
    @media (min-width: 992px) {
      .centered-row {
        justify-content: center;
      }

      .interview-layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: var(--space-lg);
        max-width: 1000px;
        margin: 0 auto;
      }
    }

    /* Participant List */
    .participant-list-container {
      max-height: 600px;
      overflow-y: auto;
    }

    .participant-item {
      background: var(--bg-alt);
      border: 1px solid var(--border);
      padding: var(--space-md);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-sm);
      transition: border-color var(--transition);
    }

    .participant-item:hover {
      border-color: var(--primary);
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-eligible {
      background: var(--success-light);
      color: var(--success);
    }

    .status-not-eligible {
      background: var(--danger-light);
      color: var(--danger);
    }

    /* Interview Tabs */
    .nav-pills {
      display: flex;
      gap: var(--space-xs);
      margin-bottom: var(--space-md);
    }

    .nav-pills .nav-link {
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-full);
      background: var(--bg-alt);
      color: var(--text-secondary);
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
    }

    .nav-pills .nav-link.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
    }

    /* Guide */
    .guide-title {
      color: var(--primary);
      font-weight: 600;
      margin-bottom: var(--space-sm);
    }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: var(--space-lg);
      right: var(--space-lg);
      z-index: 1050;
    }

    .toast {
      background: var(--primary);
      color: white;
      padding: var(--space-md) var(--space-lg);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      display: none;
    }

    .toast.show {
      display: block;
      animation: fadeIn 0.3s;
    }

    /* Utilities */
    .d-flex {
      display: flex;
    }

    .d-grid {
      display: grid;
    }

    .d-none {
      display: none;
    }

    .flex-column {
      flex-direction: column;
    }

    .flex-grow-1 {
      flex-grow: 1;
    }

    .flex-shrink-0 {
      flex-shrink: 0;
    }

    .justify-content-between {
      justify-content: space-between;
    }

    .justify-content-center {
      justify-content: center;
    }

    .justify-content-end {
      justify-content: flex-end;
    }

    .align-items-center {
      align-items: center;
    }

    .gap-2 {
      gap: var(--space-sm);
    }

    .gap-3 {
      gap: var(--space-md);
    }

    .mb-0 {
      margin-bottom: 0;
    }

    .mb-1 {
      margin-bottom: var(--space-xs);
    }

    .mb-2 {
      margin-bottom: var(--space-sm);
    }

    .mb-3 {
      margin-bottom: var(--space-md);
    }

    .mb-4 {
      margin-bottom: var(--space-lg);
    }

    .mt-2 {
      margin-top: var(--space-sm);
    }

    .mt-3 {
      margin-top: var(--space-md);
    }

    .mt-4 {
      margin-top: var(--space-lg);
    }

    .ms-1 {
      margin-left: var(--space-xs);
    }

    .me-1 {
      margin-right: var(--space-xs);
    }

    .me-2 {
      margin-right: var(--space-sm);
    }

    .p-3 {
      padding: var(--space-md);
    }

    .p-4 {
      padding: var(--space-lg);
    }

    .pb-2 {
      padding-bottom: var(--space-sm);
    }

    .pe-2 {
      padding-right: var(--space-sm);
    }

    .text-center {
      text-align: center;
    }

    .text-end {
      text-align: right;
    }

    .text-muted {
      color: var(--text-muted);
    }

    .text-uppercase {
      text-transform: uppercase;
    }

    .fw-bold {
      font-weight: 700;
    }

    .small {
      font-size: 0.875rem;
    }

    .border-bottom {
      border-bottom: 1px solid var(--border);
    }

    .border-top {
      border-top: 1px solid var(--border);
    }

    .h-100 {
      height: 100%;
    }

    .w-100 {
      width: 100%;
    }

    .overflow-auto {
      overflow: auto;
    }

    /* Audio recording */
    .blink {
      animation: blink 1s infinite;
    }

    @keyframes blink {
      50% {
        opacity: 0.5;
      }
    }

    .input-group {
      display: flex;
    }

    .input-group-text {
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-alt);
      border: 1px solid var(--border);
      border-right: none;
      border-radius: var(--radius-sm) 0 0 var(--radius-sm);
      color: var(--text-secondary);
    }

    .input-group .form-control {
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }

    .btn-group {
      display: inline-flex;
    }

    .btn-group .btn {
      border-radius: 0;
    }

    .btn-group .btn:first-child {
      border-radius: var(--radius-sm) 0 0 var(--radius-sm);
    }

    .btn-group .btn:last-child {
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }

    .btn-group-sm .btn {
      padding: var(--space-xs) var(--space-sm);
      font-size: 0.8rem;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-success {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }

    .btn-warning {
      background: var(--warning);
      color: #000;
      border-color: var(--warning);
    }

    .btn-info {
      background: var(--info);
      color: white;
      border-color: var(--info);
    }

    .rounded-pill {
      border-radius: var(--radius-full);
    }

    .bg-secondary {
      background: var(--bg-alt);
    }

    .text-danger {
      color: var(--danger);
    }

    .text-success {
      color: var(--success);
    }

    .badge {
      display: inline-block;
      padding: 0.25em 0.6em;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: var(--radius-sm);
    }

    .bg-warning {
      background: var(--warning);
      color: #000;
    }

    /* Sync Status */
    .sync-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-sm);
      background: var(--bg-alt);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    .sync-status.offline .status-dot {
      background: var(--danger);
    }

    /* Mobile Menu */
    .mobile-menu-toggle {
      display: none;
      background: none;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.5rem;
      cursor: pointer;
      color: var(--text);
    }

    .mobile-menu-toggle i {
      font-size: 1.25rem;
    }

    .header-nav {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    @media (max-width: 576px) {
      .mobile-menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .header-nav {
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        padding: var(--space-md);
        flex-direction: column;
        gap: var(--space-sm);
        box-shadow: var(--shadow-md);
        display: none;
        z-index: 99;
      }

      .header-nav.show {
        display: flex;
      }

      .header-nav .btn {
        width: 100%;
        justify-content: center;
      }

      .header-nav .sync-status {
        width: 100%;
        justify-content: center;
      }
    }

    /* Dashboard Metrics Grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-md);
    }

    @media (max-width: 992px) {
      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-sm);
      }

      .metric-number {
        font-size: 1.8rem;
      }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="app-header">
    <div class="container">
      <div class="brand">
        <a href="./" style="display: flex; align-items: center; gap: 0.5rem;">
          <img src="./assets/img/uhas.jpg" alt="UHAS" class="brand-logo">
          <span class="brand-divider"></span>
          <img src="./assets/img/hpi.png" alt="HPI" class="brand-logo">
        </a>
        <span class="brand-text">Toolkit A</span>
      </div>

      <button class="mobile-menu-toggle" onclick="document.getElementById('headerNav').classList.toggle('show')">
        <i class="bi bi-list"></i>
      </button>

      <div class="header-nav" id="headerNav">
        <div class="sync-status" id="syncStatus">
          <span class="status-dot"></span>
          <span>Online</span>
        </div>
        <a href="#" class="btn btn-outline" title="Back" onclick="history.back()"><i class="bi bi-arrow-left"></i> Back</a>
        <a href="./" class="btn btn-outline" title="Home"><i class="bi bi-house-fill"></i></a>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container" style="padding: var(--space-lg) var(--space-lg) 100px;">
    <!-- Navigation Grid -->
    <div class="grid mb-4">
      <div class="nav-card active" data-target="dashboard">
        <div class="card-icon"><i class="bi bi-speedometer2"></i></div>
        <h3>Dashboard</h3>
      </div>
      <div class="nav-card" data-target="screening">
        <div class="card-icon"><i class="bi bi-person-lines-fill"></i></div>
        <h3>Screening & Registry</h3>
      </div>
      <div class="nav-card" data-target="interview">
        <div class="card-icon"><i class="bi bi-mic"></i></div>
        <h3>Interviews</h3>
      </div>
      <div class="nav-card" data-target="data">
        <div class="card-icon"><i class="bi bi-database"></i></div>
        <h3>Data</h3>
      </div>
    </div>

    <!-- 1. DASHBOARD SECTION -->
    <div id="dashboard" class="content-section active">
      <div class="text-center mb-4">
        <h2 class="fw-bold">Study Overview</h2>
        <p class="text-muted">Hypertension Management Digital N-of-1 Trials</p>
      </div>

      <!-- Primary Metrics Row -->
      <div class="metrics-grid mb-4">
        <div class="content-box text-center p-3">
          <div class="metric-number" id="dashTotal">0</div>
          <div class="metric-label">Enrolled</div>
        </div>
        <div class="content-box text-center p-3">
          <div class="metric-number text-success" id="dashEligible">0</div>
          <div class="metric-label">Eligible</div>
        </div>
        <div class="content-box text-center p-3">
          <div class="metric-number text-warning" id="dashIneligible">0</div>
          <div class="metric-label">Ineligible</div>
        </div>
        <div class="content-box text-center p-3">
          <div class="metric-number" id="dashEligibilityRate">0%</div>
          <div class="metric-label">Eligibility Rate</div>
        </div>
      </div>

      <!-- Interview & Recording Stats Row -->
      <div class="metrics-grid mb-4">
        <div class="content-box text-center p-3">
          <div class="metric-number" id="dashInterviews">0</div>
          <div class="metric-label">Interviews Done</div>
        </div>
        <div class="content-box text-center p-3">
          <div class="metric-number" id="dashPendingIDI">0</div>
          <div class="metric-label">Pending IDIs</div>
        </div>
        <div class="content-box text-center p-3">
          <div class="metric-number" id="dashAudio">0</div>
          <div class="metric-label">Recordings</div>
        </div>
        <div class="content-box text-center p-3">
          <div class="metric-number" id="dashInterviewRate">0%</div>
          <div class="metric-label">Completion Rate</div>
        </div>
      </div>

      <!-- Participant Distribution -->
      <div class="content-box mb-4">
        <h5 class="mb-4 border-bottom pb-2"><i class="bi bi-people-fill me-2"></i>Participant Distribution</h5>
        <div class="row text-center" id="dashDistribution"></div>
      </div>

      <!-- Quick Actions -->
      <div class="content-box">
        <h5 class="mb-3 border-bottom pb-2"><i class="bi bi-lightning-fill me-2"></i>Quick Actions</h5>
        <div class="row g-2">
          <div class="col-6 col-md-4">
            <button class="btn btn-outline-primary w-100" onclick="App.switchSection('screening')">
              <i class="bi bi-person-plus me-1"></i>Screen
            </button>
          </div>
          <div class="col-6 col-md-4">
            <button class="btn btn-outline-success w-100" onclick="App.switchSection('interview')">
              <i class="bi bi-chat-dots me-1"></i>Interview
            </button>
          </div>
          <!-- Removed Data Manager Link -->
          <!-- 
          <div class="col-6 col-md-4">
            <a href="#" class="btn btn-outline-secondary w-100" onclick="history.back()">
              <i class="bi bi-database me-1"></i>Data Manager
            </a>
          </div> 
          -->
        </div>
      </div>
    </div>

    <!-- 2. SCREENING & REGISTRY SECTION -->
    <div id="screening" class="content-section">
      <div class="row g-4 centered-row">
        <!-- LEFT COLUMN: Screening Form -->
        <div class="col-lg-6">
          <div class="content-box">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="mb-0"><i class="bi bi-person-plus-fill me-2"></i>Participant Screening</h4>
              <span id="editModeBadge" class="badge bg-warning d-none">Editing Mode</span>
            </div>

            <form id="screeningForm">
              <input type="hidden" id="editOriginalId" value="">

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Participant Type</label>
                  <select class="form-control form-select" id="scrType" required>
                    <option value="">Select Type...</option>
                    <option value="patient">Patient</option>
                    <option value="clinician">Clinician</option>
                    <option value="herbalist">Herbalist</option>
                    <option value="caregiver">Caregiver</option>
                    <option value="policymaker">Policy Maker</option>
                    <option value="researcher">Researcher</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Study Site</label>
                  <select class="form-control form-select" id="scrSite">
                    <option value="">Select Site...</option>
                    <option>Tetteh Quarshie Memorial Hospital</option>
                    <option>Atibie Government Hospital</option>
                    <option>Oda Government Hospital</option>
                    <option>Suhum Government Hospital</option>
                    <option>Atua Government Hospital</option>
                    <option>Centre for Plant Medicine Research</option>
                    <option>Eastern Regional Health Directorate</option>
                    <option value="other">Other</option>
                  </select>
                  <input type="text" class="form-control mt-2 d-none" id="scrSiteOther" placeholder="Specify Site">
                </div>

                <div class="col-md-8">
                  <label class="form-label">Full Name / Initials</label>
                  <input type="text" class="form-control" id="scrName" placeholder="e.g. John Doe or J.D." required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">ID (Auto)</label>
                  <input type="text" class="form-control" id="scrId" readonly>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Age Range</label>
                  <select class="form-control form-select" id="scrAge" required>
                    <option value="18-24">18-24</option>
                    <option value="25-34">25-34</option>
                    <option value="35-44">35-44</option>
                    <option value="45-54">45-54</option>
                    <option value="55-64">55-64</option>
                    <option value="65+">65+</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Gender</label>
                  <select class="form-control form-select" id="scrGender" required>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                  </select>
                </div>

                <div class="col-12 mt-4">
                  <div class="p-3"
                    style="background: var(--bg-alt); border-radius: var(--radius-md); border: 1px solid var(--border);">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h6 class="mb-0" style="color: var(--primary);">Eligibility Criteria</h6>
                      <button type="button" class="btn btn-outline btn-sm" onclick="App.Screening.selectAllYes()">Select
                        All Yes</button>
                    </div>
                    <div id="eligibilityList">
                      <p class="text-muted small text-center">Select a participant type to see criteria.</p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="button" class="btn btn-outline" onclick="App.Screening.clearForm()">Clear/Cancel</button>
                <button type="submit" class="btn btn-primary" id="saveBtn">Save Screening</button>
              </div>
            </form>
          </div>
        </div>

        <!-- RIGHT COLUMN: Participant Registry List -->
        <div class="col-lg-4">
          <div class="content-box h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Registry</h5>
              <span class="badge" style="background: var(--bg-alt);" id="listCount">0</span>
            </div>
            <div class="mb-3">
              <div class="input-group mb-2">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" placeholder="Search name or ID..."
                  onkeyup="App.Participants.render()" id="partSearch">
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm flex-grow-1"
                  onclick="App.Data.downloadCSV('participants')">
                  <i class="bi bi-file-earmark-spreadsheet"></i> Export
                </button>
                <button class="btn btn-outline-secondary btn-sm flex-grow-1" onclick="App.Data.downloadJSON()">
                  <i class="bi bi-archive"></i> Backup
                </button>
                <button class="btn btn-outline-secondary btn-sm flex-grow-1"
                  onclick="document.getElementById('importFile').click()">
                  <i class="bi bi-upload"></i> Import
                </button>
                <input type="file" id="importFile" style="display:none" accept=".json"
                  onchange="App.Data.importJSON(this)">
              </div>
            </div>

            <div id="participantsList" class="participant-list-container pe-2">
              <div class="text-center p-4 text-muted">
                <i class="bi bi-people" style="font-size: 2rem; opacity: 0.5;"></i>
                <p class="mt-2">No participants enrolled yet.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 3. INTERVIEW SECTION -->
    <div id="interview" class="content-section">
      <div class="nav-pills mb-3" id="interviewTabs" style="justify-content: center;">
        <span class="nav-link active" data-tab="tab-idi" onclick="App.Interview.switchTab('idi')">IDI
          (Individual)</span>
        <span class="nav-link" data-tab="tab-fgd" onclick="App.Interview.switchTab('fgd')">FGD (Group)</span>
      </div>

      <div class="tab-content">
        <!-- IDI Tab -->
        <div class="tab-pane active" id="tab-idi">
          <div class="interview-layout">
            <div class="content-box p-3">
              <h6 class="border-bottom pb-2 mb-3" style="color: var(--primary);"><i class="bi bi-book me-2"></i>IDI
                Guide</h6>
              <div id="idiGuide" class="small overflow-auto" style="max-height: 400px;">
                <p class="text-muted">Select a participant to load the tailored guide.</p>
              </div>
            </div>
            <div class="content-box">
              <div class="mb-3">
                <label class="form-label">Select Participant</label>
                <select class="form-control form-select" id="idiParticipantSelect"
                  onchange="App.Interview.handleParticipantChange(this.value, 'idi')"></select>
              </div>

              <!-- Audio Controls -->
              <div class="content-box mb-3" style="background: var(--bg-alt);">
                <div class="text-center">
                  <div class="d-flex justify-content-center gap-2 mb-2">
                    <button class="btn btn-success rounded-pill" id="btnRecIdi" onclick="App.Audio.toggle('idi')">
                      <i class="bi bi-record-circle"></i> Record
                    </button>
                    <button class="btn btn-danger rounded-pill" id="btnPauseIdi" onclick="App.Audio.pause('idi')"
                      disabled>
                      <i class="bi bi-pause"></i> Pause
                    </button>
                  </div>
                  <div id="statusIdi" class="small text-muted mb-2">Ready</div>
                  <audio id="playerIdi" controls class="w-100" style="display:none; height: 30px;"></audio>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Notes</label>
                <textarea class="form-control" id="idiNotes" rows="6"
                  placeholder="Interview transcript/notes..."></textarea>
              </div>
              <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-outline" onclick="App.Interview.save('idi')">Save Draft</button>
                <button class="btn btn-primary" onclick="App.Interview.complete('idi')">Complete Interview</button>
              </div>
            </div>
          </div>
        </div>

        <!-- FGD Tab -->
        <div class="tab-pane" id="tab-fgd">
          <div class="interview-layout">
            <div class="content-box p-3">
              <h6 class="border-bottom pb-2 mb-3" style="color: var(--primary);"><i class="bi bi-people me-2"></i>FGD
                Guide</h6>
              <div class="mb-2">
                <select class="form-control form-select" id="fgdGuideType" onchange="App.Interview.updateFgdGuide()">
                  <option value="mixed">Mixed Group (Default)</option>
                  <option value="patient">Patients Only</option>
                  <option value="clinician">Clinicians Only</option>
                </select>
              </div>
              <div id="fgdGuide" class="small overflow-auto" style="max-height: 350px;"></div>
            </div>
            <div class="content-box">
              <div class="row g-2 mb-3">
                <div class="col-md-6">
                  <label class="form-label">Group Name</label>
                  <input type="text" class="form-control" id="fgdName" placeholder="e.g. Group A">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Participants (Hold Ctrl)</label>
                  <select class="form-control form-select" id="fgdParticipantSelect" multiple
                    style="height: 100px;"></select>
                </div>
              </div>

              <!-- Audio Controls FGD -->
              <div class="content-box mb-3" style="background: var(--bg-alt);">
                <div class="text-center">
                  <div class="d-flex justify-content-center gap-2 mb-2">
                    <button class="btn btn-success rounded-pill" id="btnRecFgd" onclick="App.Audio.toggle('fgd')">
                      <i class="bi bi-record-circle"></i> Record
                    </button>
                    <button class="btn btn-danger rounded-pill" id="btnPauseFgd" onclick="App.Audio.pause('fgd')"
                      disabled>
                      <i class="bi bi-pause"></i> Pause
                    </button>
                  </div>
                  <div id="statusFgd" class="small text-muted mb-2">Ready</div>
                  <audio id="playerFgd" controls class="w-100" style="display:none; height: 30px;"></audio>
                </div>
              </div>

              <div class="mb-3">
                <textarea class="form-control" id="fgdNotes" rows="5" placeholder="FGD Notes..."></textarea>
              </div>
              <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-outline" onclick="App.Interview.save('fgd')">Save Draft</button>
                <button class="btn btn-primary" onclick="App.Interview.complete('fgd')">Complete FGD</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>

    <!-- 4. DATA SECTION -->
    <div id="data" class="content-section">
      <div class="content-box">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="mb-0"><i class="bi bi-database me-2"></i>Data Management</h4>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" onclick="DataManager.importData()" title="Import JSON or CSV">
              <i class="bi bi-upload me-1"></i> Import
            </button>
            <button class="btn btn-outline-success btn-sm" onclick="DataManager.exportAllJSON()" title="Export all data as JSON">
              <i class="bi bi-download me-1"></i> Export JSON
            </button>
            <button class="btn btn-outline-success btn-sm" onclick="DataManager.exportAllCSV()" title="Export as CSV">
              <i class="bi bi-download me-1"></i> Export CSV
            </button>
          </div>
        </div>

        <!-- Offline Data Sharing Info -->
        <div class="alert mb-4" style="background: var(--primary); border: none; color: white; padding: 16px; border-radius: 8px;">
          <h5 style="margin-bottom: 8px; color: white;"><i class="bi bi-phone me-2"></i>ðŸ“± Data Sharing</h5>
          <p style="margin: 0; font-size: 0.95rem; color: white;">All data is stored <strong>locally on your device</strong>. To share responses, export as JSON/CSV and audio files, then send directly to WhatsApp: <strong>+233 XXX XXX XXXX</strong></p>
        </div>

        <ul class="nav nav-pills mb-3" id="dataTabs">
          <li class="nav-item">
            <a class="nav-link active" onclick="App.Data.switchTable('participants')">Participants</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" onclick="App.Data.switchTable('interviews')">Interviews</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" onclick="App.Data.switchTable('audio')">Audio</a>
          </li>
        </ul>

        <div class="table-responsive">
          <table class="table table-hover" id="dataTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Type/Mode</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="dataList">
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>

        <!-- Audio List Container (Hidden by default, shown when Audio tab active) -->
        <div id="audioListContainer" class="d-none">
          <div id="audioList"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast Notification -->
  <div class="toast-container">
    <div id="liveToast" class="toast" role="alert">
      <span id="toastMsg">Action Successful</span>
    </div>
  </div>

  <!-- APP LOGIC -->
  <script>
    const App = {
      State: {
        participants: [],
        interviews: [],
        audioRecordings: [],
        audioBlobs: {}
      },

      // IndexedDB for audio storage
      AudioDB: {
        db: null,
        dbName: 'toolkit-a-audio',
        dbVersion: 1,

        init: async function () {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.dbVersion);

            request.onerror = () => reject(request.error);

            request.onsuccess = () => {
              this.db = request.result;
              console.log('âœ… Audio IndexedDB initialized');
              resolve(this.db);
            };

            request.onupgradeneeded = (event) => {
              const db = event.target.result;
              if (!db.objectStoreNames.contains('audioBlobs')) {
                db.createObjectStore('audioBlobs', { keyPath: 'id' });
              }
            };
          });
        },

        saveBlob: async function (id, blob, metadata = {}) {
          return new Promise((resolve, reject) => {
            if (!this.db) return reject(new Error('DB not initialized'));

            const tx = this.db.transaction('audioBlobs', 'readwrite');
            const store = tx.objectStore('audioBlobs');

            const record = {
              id,
              blob,
              metadata,
              createdAt: new Date().toISOString(),
              synced: false
            };

            const request = store.put(record);
            request.onsuccess = () => resolve(record);
            request.onerror = () => reject(request.error);
          });
        },

        getBlob: async function (id) {
          return new Promise((resolve, reject) => {
            if (!this.db) return reject(new Error('DB not initialized'));

            const tx = this.db.transaction('audioBlobs', 'readonly');
            const store = tx.objectStore('audioBlobs');
            const request = store.get(id);

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
          });
        },

        getAllBlobs: async function () {
          return new Promise((resolve, reject) => {
            if (!this.db) return reject(new Error('DB not initialized'));

            const tx = this.db.transaction('audioBlobs', 'readonly');
            const store = tx.objectStore('audioBlobs');
            const request = store.getAll();

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
          });
        },

        markSynced: async function (id) {
          const record = await this.getBlob(id);
          if (record) {
            record.synced = true;
            record.syncedAt = new Date().toISOString();
            return new Promise((resolve, reject) => {
              const tx = this.db.transaction('audioBlobs', 'readwrite');
              const store = tx.objectStore('audioBlobs');
              const request = store.put(record);
              request.onsuccess = () => resolve(record);
              request.onerror = () => reject(request.error);
            });
          }
        },

        deleteBlob: async function (id) {
          return new Promise((resolve, reject) => {
            if (!this.db) return reject(new Error('DB not initialized'));

            const tx = this.db.transaction('audioBlobs', 'readwrite');
            const store = tx.objectStore('audioBlobs');
            const request = store.delete(id);

            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
          });
        }
      },

      init: async function () {
        // Initialize IndexedDB
        try {
          if (typeof UhasIDB !== 'undefined') {
            await UhasIDB.init();
            console.log('âœ… IndexedDB initialized for offline use');
          }
        } catch (err) {
          console.error('Failed to init IndexedDB:', err);
        }

        // Initialize IndexedDB for audio
        try {
          await this.AudioDB.init();
          // Load audio blobs from IndexedDB into memory
          const storedAudios = await this.AudioDB.getAllBlobs();
          storedAudios.forEach(record => {
            this.State.audioBlobs[record.id] = record.blob;
          });
          console.log(`âœ… Loaded ${storedAudios.length} audio recordings from IndexedDB`);
        } catch (err) {
          console.error('Failed to init audio DB:', err);
        }

        await this.Storage.load();
        this.Navigation.init();
        this.Screening.initListeners();
        this.Dashboard.update();
        this.SyncStatus.init();
        console.log("Toolkit A Initialized");
      },

      $: (id) => document.getElementById(id),

      Toast: (msg) => {
        const toastEl = document.getElementById('liveToast');
        document.getElementById('toastMsg').textContent = msg;
        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), 3000);
      },

      SyncStatus: {
        init: () => {
          App.SyncStatus.update();
          window.addEventListener('online', App.SyncStatus.update);
          window.addEventListener('offline', App.SyncStatus.update);
        },
        update: () => {
          const el = App.$('syncStatus');
          if (el) {
            if (navigator.onLine) {
              el.classList.remove('offline');
              el.innerHTML = '<span class="status-dot"></span><span>Online</span>';
            } else {
              el.classList.add('offline');
              el.innerHTML = '<span class="status-dot"></span><span>Offline</span>';
            }
          }
        }
      },

      Storage: {
        save: async () => {
          try {
            // Save participants
            for (const p of App.State.participants) {
              await UhasIDB.put('participants', p);
            }

            // Save interviews
            for (const i of App.State.interviews) {
              const record = { ...i, type: 'toolkit-a-interview', module: 'toolkit-a' };
              await UhasIDB.put('interviews', record);
            }

            // Save audio metadata
            for (const r of App.State.audioRecordings) {
              // Ensure we don't save blobs here, they are in AudioDB
              const { blob, url, ...metadata } = r;
              const record = { ...metadata, type: 'toolkit-a-recording', module: 'toolkit-a' };
              await UhasIDB.put('audioRecordings', record);
            }

            // Backup to localstorage for safety
            // localStorage.setItem('toolkit_a_backup', JSON.stringify({ timestamp: Date.now() }));

            App.Dashboard.update();

            // Auto-sync to cloud if online
            if (window.syncService && navigator.onLine) {
              console.log('ðŸ”„ Triggering background sync...');
              window.syncService.syncAllToolkit().catch(err => console.warn('Background sync failed:', err));
            }
          } catch (error) {
            console.error('Storage save failed:', error);
            App.Toast('Error saving data');
          }
        },

        load: async () => {
          try {
            // 1. Try loading from IndexedDB
            let participants = await UhasIDB.getAll('participants');
            let toolkitData = await UhasIDB.getAll('interviews');
            let audioRecordingsMeta = await UhasIDB.getAll('audioRecordings');

            // 2. Set State directly from stores
            App.State.participants = participants || [];
            App.State.interviews = toolkitData || [];

            // For recordings, use metadata from AudioRecordings store
            const recordingMeta = audioRecordingsMeta || [];

            // We need to preserve the blobs if they are already loaded in State.audioBlobs (handled in init)
            // But State.audioRecordings is rewritten here.
            App.State.audioRecordings = recordingMeta.map(meta => {
              // The blob might be in App.State.audioBlobs[meta.id] if loaded
              return { ...meta };
            });

          } catch (error) {
            console.error('Storage load failed:', error);
            // Fallback to empty state
            App.State.participants = [];
            App.State.interviews = [];
            App.State.audioRecordings = [];
          }
        }
      },

      Navigation: {
        init: () => {
          const cards = document.querySelectorAll('.nav-card');
          const sections = document.querySelectorAll('.content-section');

          cards.forEach(card => {
            card.addEventListener('click', () => {
              cards.forEach(c => c.classList.remove('active'));
              card.classList.add('active');

              const targetId = card.dataset.target;
              sections.forEach(s => s.classList.remove('active'));
              App.$(targetId).classList.add('active');

              if (targetId === 'screening') App.Participants.render();
              if (targetId === 'data') App.Data.renderAudioList();
              if (targetId === 'interview') {
                App.Interview.loadParticipants('idi');
                App.Interview.loadParticipants('fgd');
                App.Interview.updateFgdGuide();
              }
            });
          });
        },

        goTo: (targetId) => {
          const selector = `.nav-card[data-target="${targetId}"]`;
          const card = document.querySelector(selector);
          if (card) card.click();
        }
      },

      Dashboard: {
        update: () => {
          const s = App.State;

          // Primary metrics
          const totalEnrolled = s.participants.length;
          const eligible = s.participants.filter(p => p.isEligible).length;
          const ineligible = s.participants.filter(p => !p.isEligible).length;
          const eligibilityRate = totalEnrolled > 0 ? Math.round((eligible / totalEnrolled) * 100) : 0;

          // Interview & recording stats
          const totalInterviews = s.interviews.length;
          const eligibleForIDI = eligible;
          const pendingIDI = eligibleForIDI - totalInterviews;
          const totalRecordings = s.audioRecordings.length;
          const interviewRate = eligibleForIDI > 0 ? Math.round((totalInterviews / eligibleForIDI) * 100) : 0;

          // Update primary metrics
          App.$('dashTotal').textContent = totalEnrolled;
          App.$('dashEligible').textContent = eligible;
          App.$('dashIneligible').textContent = ineligible;
          App.$('dashEligibilityRate').textContent = `${eligibilityRate}%`;

          // Update interview metrics
          App.$('dashInterviews').textContent = totalInterviews;
          App.$('dashPendingIDI').textContent = Math.max(0, pendingIDI);
          App.$('dashAudio').textContent = totalRecordings;
          App.$('dashInterviewRate').textContent = `${interviewRate}%`;

          // Participant distribution by type
          const types = ['patient', 'clinician', 'herbalist', 'caregiver', 'policymaker', 'researcher'];
          const typeLabels = {
            patient: 'Patients',
            clinician: 'Clinicians',
            herbalist: 'Herbalists',
            caregiver: 'Caregivers',
            policymaker: 'Policy Makers',
            researcher: 'Researchers'
          };

          const html = types.map(t => {
            const count = s.participants.filter(p => p.type === t).length;
            const eligibleCount = s.participants.filter(p => p.type === t && p.isEligible).length;
            return `
              <div class="col-md-4 col-6 mb-3">
                <div class="p-2 rounded" style="background: var(--bg);">
                  <div class="text-muted small text-uppercase">${typeLabels[t]}</div>
                  <div class="fw-bold" style="font-size: 1.25rem;">${count}</div>
                  <div class="small text-success">${eligibleCount} eligible</div>
                </div>
              </div>
            `;
          }).join('');
          App.$('dashDistribution').innerHTML = html;
        }
      },

      Screening: {
        initListeners: () => {
          App.$('scrType').addEventListener('change', (e) => App.Screening.renderCriteria(e.target.value));
          App.$('scrSite').addEventListener('change', (e) => {
            const other = App.$('scrSiteOther');
            if (e.target.value === 'other') other.classList.remove('d-none');
            else other.classList.add('d-none');
          });
          App.$('screeningForm').addEventListener('submit', App.Screening.save);
        },

        renderCriteria: (type, existingCriteria = null) => {
          const criteriaMap = {
            patient: ['Aged 18+', 'Hypertension (â‰¥6mo)', 'Conventional/Herbal Tx', 'Smartphone Access', 'Willing to Participate', 'Informed Consent'],
            clinician: ['Aged 18+', 'Licensed Professional', 'Exp â‰¥6mo', 'Eastern Region', 'Comfortable with Digital', 'Informed Consent'],
            herbalist: ['Aged 18+', 'Herbal Practitioner', 'Exp â‰¥6mo', 'Eastern Region', 'Open to Research', 'Informed Consent'],
            caregiver: ['Aged 18+', 'Provides Regular Support', 'Caregiving â‰¥3mo', 'Aware of Tx', 'Reachable', 'Informed Consent'],
            policymaker: ['Aged 18+', 'Policy Role', 'Active in Health Sector', 'Familiar with NCDs', 'Willing to Dialogue', 'Informed Consent'],
            researcher: ['Aged 18+', 'Relevant Degree', 'Research Exp â‰¥6mo', 'Based in Region', 'Digital Data Exp', 'Informed Consent']
          };

          const list = criteriaMap[type] || [];
          const html = list.map((c, i) => `
            <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
              <span class="small flex-grow-1 pe-2">${c}</span>
              <div class="btn-group btn-group-sm flex-shrink-0">
                <input type="radio" class="btn-check" name="crit_${i}" id="y_${i}" value="yes" required ${existingCriteria && existingCriteria[i] === 'yes' ? 'checked' : ''}>
                <label class="btn btn-outline" style="border-color: var(--success); color: var(--success);" for="y_${i}">Yes</label>
                <input type="radio" class="btn-check" name="crit_${i}" id="n_${i}" value="no" ${existingCriteria && existingCriteria[i] === 'no' ? 'checked' : ''}>
                <label class="btn btn-outline" style="border-color: var(--danger); color: var(--danger);" for="n_${i}">No</label>
              </div>
            </div>
          `).join('');
          App.$('eligibilityList').innerHTML = html || '<p class="text-muted small">Select a valid type.</p>';

          if (!App.$('editOriginalId').value) {
            App.Screening.generateId(type);
          }
        },

        generateId: (type) => {
          if (!type) return;
          const prefixMap = { patient: 'PAT', clinician: 'CLN', herbalist: 'HRB', caregiver: 'CG', policymaker: 'POL', researcher: 'RES' };
          const prefix = prefixMap[type] || 'PAR';
          const count = App.State.participants.filter(p => p.type === type).length + 1;
          App.$('scrId').value = `${prefix}${String(count).padStart(3, '0')}`;
        },

        selectAllYes: () => {
          document.querySelectorAll('#eligibilityList input[value="yes"]').forEach(r => r.checked = true);
        },

        loadForEdit: (participant) => {
          App.$('scrType').value = participant.type;
          App.$('scrName').value = participant.name;
          App.$('scrAge').value = participant.age;
          App.$('scrGender').value = participant.gender;
          App.$('scrId').value = participant.id;
          App.$('editOriginalId').value = participant.id;

          const defaultSites = ['Tetteh Quarshie Memorial Hospital', 'Atibie Government Hospital', 'Oda Government Hospital', 'Suhum Government Hospital', 'Atua Government Hospital', 'Centre for Plant Medicine Research', 'Eastern Regional Health Directorate'];
          if (defaultSites.includes(participant.site)) {
            App.$('scrSite').value = participant.site;
            App.$('scrSiteOther').classList.add('d-none');
          } else {
            App.$('scrSite').value = 'other';
            App.$('scrSiteOther').classList.remove('d-none');
            App.$('scrSiteOther').value = participant.site;
          }

          App.Screening.renderCriteria(participant.type, participant.criteria);
          App.$('editModeBadge').classList.remove('d-none');
          App.$('saveBtn').textContent = "Update Participant";
          App.$('screeningForm').scrollIntoView({ behavior: 'smooth' });
        },

        save: (e) => {
          e.preventDefault();

          // Custom Validation for Site
          const siteSelect = App.$('scrSite');
          const siteOther = App.$('scrSiteOther');
          let siteValue = siteSelect.value;

          if (!siteValue) {
            alert("Please select a Study Site");
            siteSelect.focus();
            return;
          }

          if (siteValue === 'other') {
            siteValue = siteOther.value.trim();
            if (!siteValue) {
              alert("Please specify the other site");
              siteOther.focus();
              return;
            }
          }

          const criteriaElements = document.querySelectorAll('#eligibilityList input:checked');
          const criteriaValues = Array.from(criteriaElements).map(el => el.value);
          const isEligible = criteriaValues.every(v => v === 'yes') && criteriaValues.length > 0;
          const editId = App.$('editOriginalId').value;

          const participant = {
            id: editId || App.$('scrId').value,
            type: App.$('scrType').value,
            name: App.$('scrName').value,
            site: App.$('scrSite').value === 'other' ? App.$('scrSiteOther').value.trim() : App.$('scrSite').value,
            age: App.$('scrAge').value,
            gender: App.$('scrGender').value,
            isEligible: isEligible,
            criteria: criteriaValues,
            date: new Date().toISOString(),
            synced: false
          };

          // Update State (Handle Add vs Edit)
          if (editId) {
            const index = App.State.participants.findIndex(p => p.id === editId);
            if (index !== -1) {
              App.State.participants[index] = participant;
              App.Toast("Participant Updated!");
            }
          } else {
            App.State.participants.push(participant);
            App.Toast(isEligible ? "Participant Enrolled!" : "Participant Screened (Ineligible)");
          }

          // Save to Unified DB
          db.upsert('participants', participant).then(() => {
            console.log('âœ… Participant saved to IDB');
          }).catch(err => console.error('âŒ Failed to save participant to IDB', err));

          App.Storage.save();
          App.Screening.clearForm();
          App.Participants.render();
        },

        clearForm: () => {
          App.$('screeningForm').reset();
          App.$('eligibilityList').innerHTML = '';
          App.$('scrId').value = '';
          App.$('scrSiteOther').classList.add('d-none');
          App.$('editOriginalId').value = '';
          App.$('editModeBadge').classList.add('d-none');
          App.$('saveBtn').textContent = "Save Screening";
        }
      },

      Interview: {
        switchTab: (mode) => {
          document.querySelectorAll('.nav-pills .nav-link').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));

          if (mode === 'idi') {
            document.querySelector('[data-tab="tab-idi"]').classList.add('active');
            App.$('tab-idi').classList.add('active');
            App.Interview.loadParticipants('idi');
          } else {
            document.querySelector('[data-tab="tab-fgd"]').classList.add('active');
            App.$('tab-fgd').classList.add('active');
            App.Interview.loadParticipants('fgd');
          }
        },

        loadParticipants: (mode) => {
          const select = mode === 'idi' ? App.$('idiParticipantSelect') : App.$('fgdParticipantSelect');
          select.innerHTML = mode === 'idi' ? '<option value="">Select...</option>' : '';

          const list = App.State.participants.filter(p => p.isEligible);
          list.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = `${p.id} - ${p.name}`;
            select.appendChild(opt);
          });
        },

        handleParticipantChange: (id, mode) => {
          if (mode === 'idi' && id) {
            const p = App.State.participants.find(p => p.id === id);
            App.Interview.renderIdiGuide(p.type);
          }
        },

        renderIdiGuide: (type) => {
          const guides = {
            patient: `<h6 class='guide-title text-primary mb-3'><i class='bi bi-person-heart me-2'></i>Patient Survey-Based Interview Guide</h6>
              <p class='alert alert-info small mb-3'><i class='bi bi-info-circle me-1'></i><strong>Note:</strong> This is a conversational interview guide based on our survey questionnaire. Ask questions naturally, probe for details, and let the participant elaborate.</p>
              
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>SECTION A: DEMOGRAPHIC INFORMATION (3-5 mins)</strong>
                <ol class='ps-3'>
                  <li>Let's start with some basic information about yourself:
                    <ul class='small'>
                      <li>A1. What age group are you in? <em class='text-muted'>(18-24, 25-34, 35-44, 45-54, 55-64, 65+)</em></li>
                      <li>A2. Gender?</li>
                      <li>A3. What's your highest level of education? <em class='text-muted'>(No formal education, Primary, JHS, SHS, Tertiary, Other)</em></li>
                      <li>A4. Current employment status? <em class='text-muted'>(Full-time, Part-time, Self-employed, Unemployed, Retired, Student)</em></li>
                      <li>A5. Marital status? <em class='text-muted'>(Single, Married, Divorced/Separated, Widowed)</em></li>
                    </ul>
                  </li>
                </ol>
              </div>
              
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>SECTION B: HYPERTENSION DIAGNOSIS & TREATMENT HISTORY (12-15 mins)</strong>
                <ol class='ps-3'>
                  <li><strong>B1.</strong> How long ago were you diagnosed with hypertension? <em class='text-muted'>(Less than 6 months, 6mo-1yr, 1-3yrs, 3-5yrs, More than 5yrs)</em>
                    <ul class='small text-muted'><li>Probe: Tell me about that day - how did you feel? What were you told?</li></ul>
                  </li>
                  <li><strong>B2.</strong> Where do you usually receive treatment for your blood pressure? <em class='text-muted'>(Can select multiple)</em>
                    <ul class='small'>
                      <li>Government hospital/clinic?</li>
                      <li>Private hospital/clinic?</li>
                      <li>Community health center (CHPS)?</li>
                      <li>Pharmacy?</li>
                      <li>Herbal practitioner?</li>
                      <li>Faith healer/spiritual center?</li>
                      <li>Self-medication at home?</li>
                      <li>Other?</li>
                    </ul>
                    <ul class='small text-muted'><li>Probe: Why did you choose these places? How often do you go?</li></ul>
                  </li>
                  <li><strong>B3.</strong> Are you currently taking prescribed medication for hypertension? <em class='text-muted'>(Yes/No)</em>
                    <ul class='small text-muted'><li>If No: Why not? What are you doing instead?</li></ul>
                  </li>
                  <li><strong>B4.</strong> [If taking medication] In the past month, how often did you take your prescribed medication as directed?
                    <ul class='small'><li>Every day (100%)? Most days (75-99%)? Sometimes (50-74%)? Rarely (25-49%)? Never (0-24%)?</li></ul>
                    <ul class='small text-muted'><li>Probe: Be honest - no judgment. This helps us understand real challenges.</li></ul>
                  </li>
                  <li><strong>B5.</strong> What are the main reasons you sometimes miss taking your medication? <em class='text-muted'>(Select all that apply)</em>
                    <ul class='small'>
                      <li>Forget to take it?</li>
                      <li>Cost too high?</li>
                      <li>Medication finished/not available?</li>
                      <li>Side effects?</li>
                      <li>Feeling better/no symptoms?</li>
                      <li>Distance to health facility?</li>
                      <li>Using herbal remedies instead?</li>
                      <li>Other reasons?</li>
                    </ul>
                    <ul class='small text-muted'><li>Probe: Tell me more about that. How does this affect your BP control?</li></ul>
                  </li>
                  <li><strong>B6.</strong> Do you currently use any herbal or traditional remedies for your blood pressure? <em class='text-muted'>(Yes/No)</em></li>
                  <li><strong>B7.</strong> [If yes] Which herbal remedies do you use?
                    <ul class='small'>
                      <li>Garlic? Ginger? Neem leaves? Moringa? Bitter leaf?</li>
                      <li>African star apple (Alasa)? Mixture from herbalist? Other?</li>
                    </ul>
                    <ul class='small text-muted'><li>Probe: How do you prepare them? Who taught you? Do they help?</li></ul>
                  </li>
                  <li><strong>B8.</strong> [If using herbs] How often do you use these herbal remedies?
                    <ul class='small'><li>Daily? Several times per week? Once a week? Occasionally? Only when symptoms worsen?</li></ul>
                  </li>
                </ol>
              </div>
              
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>SECTION C: BELIEFS & ATTITUDES (8-10 mins)</strong>
                <p class='small text-muted mb-2'><em>For each statement, ask: Do you strongly agree, agree, neutral, disagree, or strongly disagree? (Scale 1-5)</em></p>
                <ol class='ps-3'>
                  <li><strong>C1.</strong> Hospital medications are effective for controlling my blood pressure</li>
                  <li><strong>C2.</strong> Herbal remedies are effective for controlling my blood pressure</li>
                  <li><strong>C3.</strong> Combining hospital medicine with herbs could work better than either alone
                    <ul class='small text-muted'><li>Probe: Why do you think so? Have you tried this?</li></ul>
                  </li>
                  <li><strong>C4.</strong> I trust my doctor/nurse to make the best treatment decisions for me</li>
                  <li><strong>C5.</strong> I trust herbal practitioners to treat my blood pressure safely</li>
                  <li><strong>C6.</strong> Spiritual/religious practices help control blood pressure
                    <ul class='small text-muted'><li>Probe: Tell me about that. What practices?</li></ul>
                  </li>
                  <li><strong>C7.</strong> My blood pressure problem is caused by stress and worry</li>
                  <li><strong>C8.</strong> My blood pressure problem is hereditary (runs in family)</li>
                  <li><strong>C9.</strong> Diet and exercise can control blood pressure without medication
                    <ul class='small text-muted'><li>Probe: Have you tried this? What happened?</li></ul>
                  </li>
                  <li><strong>C10.</strong> I am satisfied with my current blood pressure treatment</li>
                </ol>
              </div>
              
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>SECTION D: COMMUNICATION WITH HEALTHCARE PROVIDERS (5-7 mins)</strong>
                <ol class='ps-3'>
                  <li><strong>D1.</strong> Have you told your doctor about herbal remedies you use?
                    <ul class='small'><li>Yes, told them everything? Yes, but only some? No, haven't told them? Not applicable - don't use herbs?</li></ul>
                  </li>
                  <li><strong>D2.</strong> [If haven't told] Why not? <em class='text-muted'>(Select all)</em>
                    <ul class='small'>
                      <li>They didn't ask?</li>
                      <li>Afraid they would disapprove?</li>
                      <li>Don't think it's important?</li>
                      <li>Don't think they would understand?</li>
                    </ul>
                    <ul class='small text-muted'><li>Probe: What do you think they would say if you told them?</li></ul>
                  </li>
                  <li><strong>D3.</strong> How comfortable are you discussing herbal treatments with your doctor?
                    <ul class='small'><li>Very comfortable? Somewhat comfortable? Neutral? Somewhat uncomfortable? Very uncomfortable?</li></ul>
                    <ul class='small text-muted'><li>Probe: Why do you feel this way? Has this always been the case?</li></ul>
                  </li>
                </ol>
              </div>
              
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>SECTION E: BARRIERS TO HYPERTENSION MANAGEMENT (7-9 mins)</strong>
                <p class='small text-muted mb-2'><em>For each barrier, ask: How much does this affect your BP management? Not at all, A little, Moderately, Quite a bit, or Extremely? (Scale 1-5)</em></p>
                <ol class='ps-3'>
                  <li><strong>E1.</strong> Cost of medications</li>
                  <li><strong>E2.</strong> Cost of clinic visits</li>
                  <li><strong>E3.</strong> Distance to health facility</li>
                  <li><strong>E4.</strong> Transport costs</li>
                  <li><strong>E5.</strong> Long waiting times at clinic</li>
                  <li><strong>E6.</strong> Medication side effects
                    <ul class='small text-muted'><li>Probe: What side effects have you experienced?</li></ul>
                  </li>
                  <li><strong>E7.</strong> Forgetting to take medication
                    <ul class='small text-muted'><li>Probe: What helps you remember? What makes you forget?</li></ul>
                  </li>
                  <li><strong>E8.</strong> Work/family commitments</li>
                  <li><strong>E9.</strong> Medication not available at pharmacy</li>
                  <li><strong>E10.</strong> Not understanding treatment instructions</li>
                </ol>
              </div>
              
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>SECTION F: DIGITAL HEALTH & PERSONALIZED TREATMENT (7-9 mins)</strong>
                <ol class='ps-3'>
                  <li><strong>F1.</strong> Do you own a smartphone? <em class='text-muted'>(Yes/No)</em></li>
                  <li><strong>F2.</strong> [If yes] How comfortable are you using smartphone apps?
                    <ul class='small'>
                      <li>Very comfortable - use many apps daily?</li>
                      <li>Comfortable - use a few apps regularly?</li>
                      <li>Neutral - can use if taught?</li>
                      <li>Uncomfortable - rarely use apps?</li>
                      <li>Very uncomfortable - find apps difficult?</li>
                    </ul>
                  </li>
                  <li><strong>F3.</strong> [If has smartphone] Have you ever used a mobile health app? <em class='text-muted'>(Yes/No)</em>
                    <ul class='small text-muted'><li>If yes: Which one? Was it helpful? What did you like/dislike?</li></ul>
                  </li>
                  <li><strong>F4.</strong> Would you be willing to use a mobile app to track your BP, medications, and symptoms?
                    <ul class='small'><li>Very willing? Somewhat willing? Neutral? Somewhat unwilling? Very unwilling?</li></ul>
                    <ul class='small text-muted'><li>Probe: What would make you more willing? What concerns do you have?</li></ul>
                  </li>
                  <li><strong>F5.</strong> Would you be interested in participating in a study where different treatments are tried over time to find what works best for YOU?
                    <ul class='small'><li>Very interested? Somewhat interested? Neutral? Somewhat uninterested? Very uninterested?</li></ul>
                    <ul class='small text-muted'><li>Explain: This is called N-of-1 trial - testing what works for you personally</li></ul>
                  </li>
                  <li><strong>F6.</strong> If a mobile app could help identify which treatment works best for you personally, how valuable would that be?
                    <ul class='small'><li>Extremely valuable? Very valuable? Moderately valuable? Slightly valuable? Not at all valuable?</li></ul>
                  </li>
                </ol>
              </div>
              
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>SECTION G: OPENNESS TO INTEGRATIVE CARE (5-7 mins)</strong>
                <ol class='ps-3'>
                  <li><strong>G1.</strong> If your doctor recommended combining prescribed medication with specific herbal remedies, would you follow this advice?
                    <ul class='small'><li>Definitely yes? Probably yes? Unsure? Probably no? Definitely no?</li></ul>
                    <ul class='small text-muted'><li>Probe: Why or why not? What would you need to know first?</li></ul>
                  </li>
                  <li><strong>G2.</strong> Would you be comfortable if your doctor and a trained herbal practitioner worked together to manage your blood pressure?
                    <ul class='small'><li>Very comfortable? Somewhat comfortable? Neutral? Somewhat uncomfortable? Very uncomfortable?</li></ul>
                    <ul class='small text-muted'><li>Probe: What would this look like to you? How would it work?</li></ul>
                  </li>
                  <li><strong>G3.</strong> What concerns, if any, would you have about combining hospital medicine with herbal treatments? <em class='text-muted'>(Select all)</em>
                    <ul class='small'>
                      <li>Safety/harmful interactions?</li>
                      <li>Effectiveness might be reduced?</li>
                      <li>Too complicated to manage?</li>
                      <li>Increased cost?</li>
                      <li>What family/community might think?</li>
                      <li>Religious/cultural concerns?</li>
                      <li>No concerns?</li>
                      <li>Other?</li>
                    </ul>
                    <ul class='small text-muted'><li>Probe: Tell me more about your biggest concern.</li></ul>
                  </li>
                </ol>
              </div>
              
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>CLOSING QUESTIONS (3-5 mins)</strong>
                <ol class='ps-3'>
                  <li>Thinking about everything we've discussed, what's the ONE thing that would most help you manage your blood pressure better?</li>
                  <li>If you could design your ideal hypertension care system, what would it include?</li>
                  <li>Is there anything else about your experience with hypertension that you'd like to share?</li>
                  <li>Do you have any questions for me?</li>
                </ol>
              </div>
              
              <div class='alert alert-success small mt-3'>
                <p class='mb-2'><strong><i class='bi bi-check-circle me-1'></i>Interview Complete!</strong></p>
                <ul class='mb-0 ps-3'>
                  <li>Thank participant for their time and honest responses</li>
                  <li>Remind about confidentiality</li>
                  <li>Provide contact information for follow-up questions</li>
                  <li>Discuss next steps (if applicable)</li>
                </ul>
              </div>
              <p class='text-muted small mt-3'><i class='bi bi-clock me-1'></i>Estimated time: 60-75 minutes</p>`,

            clinician: `<h6 class='guide-title text-primary mb-3'><i class='bi bi-hospital me-2'></i>Clinician In-Depth Interview Guide</h6>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>A. BACKGROUND & PRACTICE CONTEXT (5-7 mins)</strong>
                <ol class='ps-3'>
                  <li>Tell me about your role and how long you've been practicing in this facility.</li>
                  <li>Approximately how many hypertensive patients do you see each month?</li>
                  <li>Describe the profile of a typical hypertensive patient in your practice (age, gender, socioeconomic status).</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>B. HYPERTENSION MANAGEMENT & CHALLENGES (10-12 mins)</strong>
                <ol class='ps-3'>
                  <li>Walk me through your typical approach to managing a newly diagnosed hypertensive patient.</li>
                  <li>What are the biggest challenges you face in managing hypertension in your practice?</li>
                  <li>How do you assess and monitor patient adherence to treatment? What strategies do you use?</li>
                  <li>What factors do you think most affect whether patients take their medication regularly? <em class='text-muted'>(Probe: cost, education, beliefs, access)</em></li>
                  <li>How often do you see patients with uncontrolled blood pressure despite being on medication? What do you think contributes to this?</li>
                  <li>What resources or support do you feel you need to better manage hypertensive patients?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>C. HERBAL MEDICINE & INTEGRATION (10-12 mins)</strong>
                <ol class='ps-3'>
                  <li>Do patients discuss herbal medicine use with you? How common is this?</li>
                  <li>In your experience, what proportion of hypertensive patients use herbal remedies alongside or instead of conventional treatment?</li>
                  <li>How do you respond when patients tell you they're using herbal medicines?</li>
                  <li>What are your views on integrating herbal and conventional medicine for hypertension management?</li>
                  <li>Have you observed any benefits or adverse effects from patients using both conventional and herbal treatments?</li>
                  <li>What concerns, if any, do you have about patients using herbal medicines?</li>
                  <li>Under what conditions would you be comfortable recommending or supporting herbal medicine use?</li>
                  <li>How could collaboration between conventional healthcare and herbal practitioners be structured? What would be needed?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>D. DIGITAL HEALTH & INNOVATION (7-9 mins)</strong>
                <ol class='ps-3'>
                  <li>What digital tools, if any, do you currently use in patient care? (EMR, mobile apps, telemedicine?)</li>
                  <li>Have you ever recommended digital health tools to patients for self-management?</li>
                  <li>What are your thoughts on using digital platforms for hypertension monitoring and management?</li>
                  <li>What features would be most useful in a digital health tool for managing hypertensive patients?</li>
                  <li>What barriers do you see to implementing digital health solutions in your practice?</li>
                  <li>How could digital tools help address the herbal medicine integration question?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>E. POLICY & SYSTEMS (5-7 mins)</strong>
                <ol class='ps-3'>
                  <li>What policies or guidelines currently govern herbal medicine use in your facility?</li>
                  <li>What would need to change at the system level to enable better integration of conventional and herbal approaches?</li>
                  <li>What role should research play in determining best practices for integrative hypertension management?</li>
                  <li>If you could design an ideal system for managing hypertension that incorporates both approaches, what would it look like?</li>
                  <li>Any additional thoughts on improving hypertension care in Ghana?</li>
                </ol>
              </div>
              <p class='text-muted small mt-3'><i class='bi bi-clock me-1'></i>Estimated time: 45-50 minutes</p>`,

            herbalist: `<h6 class='guide-title text-primary mb-3'><i class='bi bi-flower1 me-2'></i>Herbalist/Traditional Healer Interview Guide</h6>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>A. BACKGROUND & PRACTICE (7-9 mins)</strong>
                <ol class='ps-3'>
                  <li>Tell me about your training and experience as an herbalist/traditional healer. How long have you been practicing?</li>
                  <li>How did you learn about herbal medicine? <em class='text-muted'>(Probe: family tradition, apprenticeship, formal training)</em></li>
                  <li>Describe your typical practice setting. Where do you see patients? How many patients do you see weekly/monthly?</li>
                  <li>What are the most common conditions you treat? How common is hypertension among your patients?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>B. HERBAL TREATMENT FOR HYPERTENSION (12-15 mins)</strong>
                <ol class='ps-3'>
                  <li>What herbs or herbal preparations do you use for treating high blood pressure? Can you list them?</li>
                  <li>For each main herb: How do you prepare it? What dosage do you recommend? How long should patients take it?</li>
                  <li>How do you diagnose or know when someone has high blood pressure? What signs do you look for?</li>
                  <li>Do you use blood pressure devices? If yes, how often? If no, why not?</li>
                  <li>How do you determine if your treatment is working? What changes do you expect to see?</li>
                  <li>How long does it typically take for your herbal treatments to show effects?</li>
                  <li>What is your success rate with treating hypertension? How do you measure this?</li>
                  <li>Have you ever had cases where herbal treatment didn't work? What did you do?</li>
                  <li>Are there any side effects from the herbs you use? How do you manage them?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>C. INTERACTION WITH CONVENTIONAL MEDICINE (10-12 mins)</strong>
                <ol class='ps-3'>
                  <li>Do you have patients who also take hospital medication for blood pressure? How common is this?</li>
                  <li>What do you advise patients who are already on conventional medicine? Should they continue both or choose one?</li>
                  <li>Have you observed any interactions (good or bad) between herbal and hospital medicines?</li>
                  <li>Do you ever refer patients to hospitals or clinics? Under what circumstances?</li>
                  <li>Have you ever collaborated with doctors, nurses, or other healthcare workers? Tell me about that experience.</li>
                  <li>What is your relationship with the conventional healthcare system? <em class='text-muted'>(Probe: attitudes, barriers, opportunities)</em></li>
                  <li>What are your views on working together with conventional healthcare providers?</li>
                  <li>What would make you comfortable or willing to collaborate more closely with hospitals/clinics?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>D. KNOWLEDGE DOCUMENTATION & SHARING (5-7 mins)</strong>
                <ol class='ps-3'>
                  <li>How do you document your treatments and patient outcomes? Do you keep records?</li>
                  <li>Are you willing to share your herbal knowledge with researchers or healthcare professionals? What concerns might you have?</li>
                  <li>What would need to happen for herbal medicine to be more recognized and integrated into the mainstream health system?</li>
                  <li>Would you be interested in receiving training on topics like blood pressure measurement or patient monitoring?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>E. TECHNOLOGY & FUTURE COLLABORATION (5-7 mins)</strong>
                <ol class='ps-3'>
                  <li>Do you use any technology in your practice? (mobile phone, smartphone, computer?)</li>
                  <li>Would you be interested in using a digital tool to track patient outcomes or share information with healthcare teams?</li>
                  <li>If there was a platform that connected herbal practitioners with conventional healthcare providers, would you participate? What would you want from such a system?</li>
                  <li>What do you see as the future of herbal medicine in Ghana's healthcare system?</li>
                  <li>Any other thoughts on how we can better serve patients with high blood pressure?</li>
                </ol>
              </div>
              <p class='text-muted small mt-3'><i class='bi bi-clock me-1'></i>Estimated time: 45-55 minutes</p>`,

            caregiver: `<h6 class='guide-title text-primary mb-3'><i class='bi bi-person-hearts me-2'></i>Caregiver In-Depth Interview Guide</h6>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>A. BACKGROUND & CAREGIVING ROLE (7-9 mins)</strong>
                <ol class='ps-3'>
                  <li>Tell me about the person you care for. What is your relationship to them?</li>
                  <li>How long have you been helping them manage their hypertension?</li>
                  <li>Describe your typical caregiving responsibilities. What does a normal day look like?</li>
                  <li>Do you have other caregiving responsibilities or is this your primary role?</li>
                  <li>How has being a caregiver affected your own life? (work, family, health, etc.)</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>B. MEDICATION MANAGEMENT SUPPORT (10-12 mins)</strong>
                <ol class='ps-3'>
                  <li>How involved are you in helping with medication? <em class='text-muted'>(Probe: reminding, administering, refilling)</em></li>
                  <li>What strategies do you use to help ensure medications are taken regularly?</li>
                  <li>Have there been times when medications were missed? What caused that and how did you handle it?</li>
                  <li>What challenges have you faced in obtaining medications? <em class='text-muted'>(Probe: cost, availability, distance)</em></li>
                  <li>How do you know if the medications are working? What changes do you monitor?</li>
                  <li>Do you accompany the person to medical appointments? How often? What happens during these visits?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>C. HERBAL MEDICINE INVOLVEMENT (8-10 mins)</strong>
                <ol class='ps-3'>
                  <li>Does the person you care for use herbal or traditional remedies for blood pressure?</li>
                  <li>If yes: How did you/they learn about these remedies? Who recommended them?</li>
                  <li>What is your role in managing herbal treatments? <em class='text-muted'>(Probe: obtaining, preparing, administering)</em></li>
                  <li>Do they use both hospital and herbal medicines? How do you manage both?</li>
                  <li>What are your own beliefs about herbal medicine for hypertension? Do you think it works?</li>
                  <li>Have you observed any positive or negative effects from herbal medicine use?</li>
                  <li>Have you discussed herbal medicine use with their doctor/nurse? What was the response?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>D. MONITORING & COMMUNICATION (7-9 mins)</strong>
                <ol class='ps-3'>
                  <li>Do you monitor blood pressure at home? How often? What equipment do you use?</li>
                  <li>What symptoms or warning signs do you watch for?</li>
                  <li>How do you communicate with healthcare providers about the person's condition?</li>
                  <li>What information do you wish healthcare providers would share with you?</li>
                  <li>Have you received any training or education on hypertension management? Would you like to?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>E. TECHNOLOGY & SUPPORT NEEDS (5-7 mins)</strong>
                <ol class='ps-3'>
                  <li>Do you use a smartphone? What do you use it for?</li>
                  <li>Would you be interested in using an app or digital tool to help with caregiving tasks? What features would be helpful?</li>
                  <li>What kind of support would make caregiving easier for you? <em class='text-muted'>(Probe: information, reminders, communication tools)</em></li>
                  <li>Do you have support from other family members, friends, or community? How important is this?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>F. REFLECTIONS & RECOMMENDATIONS (3-5 mins)</strong>
                <ol class='ps-3'>
                  <li>What has been the most challenging aspect of helping someone manage hypertension?</li>
                  <li>What has worked well in your experience?</li>
                  <li>If you could design a perfect support system for caregivers, what would it include?</li>
                  <li>Is there anything else about your caregiving experience that you'd like to share?</li>
                </ol>
              </div>
              <p class='text-muted small mt-3'><i class='bi bi-clock me-1'></i>Estimated time: 40-50 minutes</p>`,

            policymaker: `<h6 class='guide-title text-primary mb-3'><i class='bi bi-building me-2'></i>Policymaker/Health Administrator Interview Guide</h6>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>A. BACKGROUND & ROLE (5-7 mins)</strong>
                <ol class='ps-3'>
                  <li>Tell me about your current role and responsibilities in the health sector.</li>
                  <li>How long have you been in this position, and what is your background in health policy/administration?</li>
                  <li>What aspects of your work relate to non-communicable diseases, particularly hypertension?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>B. HYPERTENSION BURDEN & POLICY CONTEXT (10-12 mins)</strong>
                <ol class='ps-3'>
                  <li>From your perspective, what is the current state of hypertension management in your region/Ghana?</li>
                  <li>What data or information do you have about hypertension prevalence and control in the Eastern Region?</li>
                  <li>What are the main policy priorities for NCD management currently?</li>
                  <li>What are the biggest challenges in implementing effective hypertension programs? <em class='text-muted'>(Probe: resources, infrastructure, personnel, awareness)</em></li>
                  <li>What initiatives or programs are currently in place to address hypertension? How effective are they?</li>
                  <li>How is medication access and affordability being addressed?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>C. TRADITIONAL/HERBAL MEDICINE POLICY (12-15 mins)</strong>
                <ol class='ps-3'>
                  <li>What is the current policy framework regarding traditional and herbal medicine in Ghana?</li>
                  <li>How does the health system currently interact with traditional/herbal practitioners?</li>
                  <li>What is your personal view on integrating traditional and conventional medicine for conditions like hypertension?</li>
                  <li>What are the main benefits you see in integration? What are the main concerns or risks?</li>
                  <li>What barriers exist to integration at the policy/system level? <em class='text-muted'>(Probe: legal, regulatory, professional, cultural)</em></li>
                  <li>Are there any existing examples of successful integration (in Ghana or elsewhere) that could inform policy?</li>
                  <li>What evidence would you need to support policy changes toward integration?</li>
                  <li>What regulatory framework would be needed to ensure safety and quality in an integrated system?</li>
                  <li>How would you envision credentialing or licensing of herbal practitioners?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>D. DIGITAL HEALTH & INNOVATION (8-10 mins)</strong>
                <ol class='ps-3'>
                  <li>What is the current state of digital health initiatives in your region/nationally?</li>
                  <li>What policies or strategies exist regarding digital health and telemedicine?</li>
                  <li>What role do you see for digital health tools in managing hypertension?</li>
                  <li>What infrastructure or capacity challenges exist for scaling digital health solutions?</li>
                  <li>How could digital platforms support integration of traditional and conventional approaches?</li>
                  <li>What would be needed from a policy standpoint to support digital health innovation?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>E. IMPLEMENTATION & SUSTAINABILITY (7-9 mins)</strong>
                <ol class='ps-3'>
                  <li>If an integrated hypertension management platform were developed, what would be needed for implementation?</li>
                  <li>What stakeholders would need to be involved in planning and rollout?</li>
                  <li>How would you address potential resistance from different professional groups?</li>
                  <li>What funding mechanisms could support such an intervention?</li>
                  <li>How would you measure success? What outcomes would be most important?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>F. RESEARCH & FUTURE DIRECTIONS (3-5 mins)</strong>
                <ol class='ps-3'>
                  <li>What research gaps need to be filled to inform better policy?</li>
                  <li>What role should academic-policy partnerships play in addressing hypertension?</li>
                  <li>What is your vision for hypertension management in Ghana in the next 5-10 years?</li>
                  <li>Any additional thoughts on policy directions for integrative NCD management?</li>
                </ol>
              </div>
              <p class='text-muted small mt-3'><i class='bi bi-clock me-1'></i>Estimated time: 50-60 minutes</p>`,

            researcher: `<h6 class='guide-title text-primary mb-3'><i class='bi bi-mortarboard me-2'></i>Researcher In-Depth Interview Guide</h6>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>A. BACKGROUND & RESEARCH FOCUS (5-7 mins)</strong>
                <ol class='ps-3'>
                  <li>Tell me about your current research position and institution.</li>
                  <li>What is your area of research specialization?</li>
                  <li>How does your work relate to hypertension, traditional medicine, or digital health?</li>
                  <li>Can you describe your most recent or ongoing research projects relevant to these areas?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>B. HYPERTENSION RESEARCH LANDSCAPE (10-12 mins)</strong>
                <ol class='ps-3'>
                  <li>From your research perspective, what do we know about hypertension burden and management in Ghana?</li>
                  <li>What are the key knowledge gaps in hypertension research locally? <em class='text-muted'>(Probe: epidemiology, risk factors, treatment outcomes)</em></li>
                  <li>What have studies shown about medication adherence and barriers to hypertension control in Ghana?</li>
                  <li>What social, cultural, or economic factors most influence hypertension outcomes in this context?</li>
                  <li>What methodological challenges exist in conducting hypertension research here?</li>
                  <li>What research priorities would you identify for improving hypertension management?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>C. TRADITIONAL/HERBAL MEDICINE RESEARCH (12-15 mins)</strong>
                <ol class='ps-3'>
                  <li>What research has been done on traditional/herbal medicine for hypertension in Ghana?</li>
                  <li>What does the evidence say about efficacy of commonly used herbal remedies?</li>
                  <li>What is known about safety, herb-drug interactions, and adverse effects?</li>
                  <li>What are the main challenges in researching traditional medicine? <em class='text-muted'>(Probe: standardization, methodology, funding)</em></li>
                  <li>How prevalent is concurrent use of conventional and herbal treatments? What does research show about outcomes?</li>
                  <li>What research would be needed to establish evidence-based integration of approaches?</li>
                  <li>What ethical considerations are important in traditional medicine research?</li>
                  <li>How can traditional knowledge be respectfully documented while advancing scientific understanding?</li>
                  <li>What role should community participation play in this research?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>D. DIGITAL HEALTH & IMPLEMENTATION SCIENCE (10-12 mins)</strong>
                <ol class='ps-3'>
                  <li>What digital health research has been conducted in Ghana, particularly for NCDs?</li>
                  <li>What does evidence show about effectiveness of mHealth interventions for hypertension?</li>
                  <li>What are the key considerations for designing digital health solutions for this context? <em class='text-muted'>(Probe: literacy, access, cultural appropriateness)</em></li>
                  <li>How could digital platforms facilitate research on integrative approaches?</li>
                  <li>What implementation research is needed to scale effective interventions?</li>
                  <li>What data systems and infrastructure challenges exist?</li>
                  <li>How can research better inform policy and practice?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>E. RESEARCH DESIGN & METHODS (7-9 mins)</strong>
                <ol class='ps-3'>
                  <li>If you were to design a study on integrative hypertension management, what would be your approach?</li>
                  <li>What outcomes would be most important to measure?</li>
                  <li>What study designs would be most appropriate and feasible?</li>
                  <li>How would you address potential biases and confounding factors?</li>
                  <li>What sample sizes and populations would be needed?</li>
                  <li>What would be the main ethical considerations?</li>
                </ol>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>F. COLLABORATION & FUTURE DIRECTIONS (5-7 mins)</strong>
                <ol class='ps-3'>
                  <li>What opportunities exist for interdisciplinary collaboration in this area?</li>
                  <li>How can researchers better partner with clinicians, traditional practitioners, and policymakers?</li>
                  <li>What funding opportunities exist for this type of research?</li>
                  <li>What do you see as the most promising research directions for the next 5 years?</li>
                  <li>Would you be interested in participating in research on integrative digital health platforms? What would be your role?</li>
                  <li>Any final thoughts on research priorities or approaches?</li>
                </ol>
              </div>
              <p class='text-muted small mt-3'><i class='bi bi-clock me-1'></i>Estimated time: 50-60 minutes</p>`
          };
          App.$('idiGuide').innerHTML = guides[type] || "<p class='text-muted'>Please select a participant to load the interview guide.</p>";
        },

        updateFgdGuide: () => {
          const type = App.$('fgdGuideType').value;
          const guides = {
            mixed: `<h6 class='guide-title text-accent mb-3'><i class='bi bi-people-fill me-2'></i>Mixed Stakeholder Focus Group Discussion Guide</h6>
              <p class='text-muted mb-3'><strong>Participants:</strong> 6-10 people including patients, clinicians, herbalists, caregivers, and other stakeholders</p>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>A. INTRODUCTION & ICEBREAKER (10 mins)</strong>
                <ul class='ps-3'>
                  <li>Welcome and introductions - each person shares name, role, and one thing about their experience with hypertension</li>
                  <li>Review purpose: explore different perspectives on managing hypertension and integrating approaches</li>
                  <li>Ground rules: respect all views, confidentiality, everyone's voice matters</li>
                </ul>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>B. CURRENT EXPERIENCES & CHALLENGES (15-20 mins)</strong>
                <ul class='ps-3'>
                  <li><strong>Opening Question:</strong> When you think about managing high blood pressure in our community, what comes to mind?</li>
                  <li>What are the biggest challenges patients face? <em class='text-muted'>(Get input from different stakeholder perspectives)</em></li>
                  <li>What are the biggest challenges for those providing care? <em class='text-muted'>(Clinicians, herbalists)</em></li>
                  <li>What works well currently? What successes have you seen?</li>
                  <li>Where do people go for help with hypertension? Why?</li>
                </ul>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>C. INTEGRATION OF APPROACHES (20-25 mins)</strong>
                <ul class='ps-3'>
                  <li>Many people use both hospital medicine and herbal remedies. What are your thoughts on this?</li>
                  <li><strong>For patients/caregivers:</strong> How do you decide between conventional and herbal treatments?</li>
                  <li><strong>For clinicians:</strong> How do you respond when patients use herbal medicine?</li>
                  <li><strong>For herbalists:</strong> Do you work with hospitals/clinics? Would you want to?</li>
                  <li>What would it take for these different approaches to work together? What are the benefits? What are the concerns?</li>
                  <li>Can someone share an example where combining approaches worked well? Or didn't work well?</li>
                  <li>What would need to change for better collaboration?</li>
                </ul>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>D. DIGITAL HEALTH SOLUTIONS (15-20 mins)</strong>
                <ul class='ps-3'>
                  <li>How many of you use smartphones? For what purposes?</li>
                  <li>Have any of you used health apps or digital tools? Share your experience.</li>
                  <li>If there was an app that helped manage blood pressure and connected different care providers, what should it do?</li>
                  <li>What features would be most helpful for patients? For caregivers? For health workers?</li>
                  <li>What concerns do you have about using technology for health?</li>
                  <li>How could technology help bridge conventional and herbal medicine?</li>
                </ul>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>E. IDEAL SYSTEM DESIGN (15-20 mins)</strong>
                <ul class='ps-3'>
                  <li><strong>Group Activity:</strong> Imagine we're designing a perfect system for managing hypertension together. What would it include?</li>
                  <li>How would patients get care? Where would they go?</li>
                  <li>How would different providers communicate and work together?</li>
                  <li>What information would be shared and how?</li>
                  <li>What training or support would be needed?</li>
                  <li>Who should lead or coordinate this system?</li>
                  <li>What would make it sustainable?</li>
                </ul>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>F. CLOSING & PRIORITIES (5-10 mins)</strong>
                <ul class='ps-3'>
                  <li>If you could change ONE thing to improve hypertension care, what would it be?</li>
                  <li>What are you most hopeful about? What are you most concerned about?</li>
                  <li>Anything we didn't discuss that's important?</li>
                  <li>Thank you and next steps</li>
                </ul>
              </div>
              <p class='text-muted small mt-3'><i class='bi bi-clock me-1'></i>Total estimated time: 90-120 minutes</p>
              <p class='text-info small'><i class='bi bi-info-circle me-1'></i><strong>Facilitation Tips:</strong> Ensure all voices heard, manage dominant speakers, encourage dialogue between different stakeholders, probe for concrete examples.</p>`,

            patient: `<h6 class='guide-title text-accent mb-3'><i class='bi bi-person-hearts me-2'></i>Patient-Only Focus Group Discussion Guide</h6>
              <p class='text-muted mb-3'><strong>Participants:</strong> 6-10 hypertensive patients</p>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>A. INTRODUCTION & COMMUNITY BUILDING (10 mins)</strong>
                <ul class='ps-3'>
                  <li>Welcome and introductions - first name only, how long diagnosed with high BP</li>
                  <li>Purpose: share experiences and learn from each other</li>
                  <li>Ground rules: confidentiality, respect, support each other</li>
                  <li>Icebreaker: What's one thing you've learned about living with high blood pressure?</li>
                </ul>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>B. LIVING WITH HYPERTENSION (20-25 mins)</strong>
                <ul class='ps-3'>
                  <li>Let's go around: How has hypertension affected your daily life?</li>
                  <li>What's the hardest part about managing your blood pressure?</li>
                  <li>Let's talk about medications:
                    <ul>
                      <li>How do you remember to take them?</li>
                      <li>Has anyone struggled with side effects? What did you do?</li>
                      <li>What about cost - how do you manage this?</li>
                    </ul>
                  </li>
                  <li>Have any of you missed medications? Can you share what happened and why? (Create safe space for honesty)</li>
                  <li>What strategies have you found helpful for staying on track?</li>
                </ul>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>C. HEALTHCARE EXPERIENCES (15-20 mins)</strong>
                <ul class='ps-3'>
                  <li>Let's talk about your experiences with doctors and clinics:
                    <ul>
                      <li>What has been helpful?</li>
                      <li>What has been frustrating?</li>
                      <li>What do you wish was different?</li>
                    </ul>
                  </li>
                  <li>How comfortable do you feel asking questions or raising concerns with your healthcare provider?</li>
                  <li>Do you feel listened to and understood? Why or why not?</li>
                </ul>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>D. HERBAL MEDICINE USE (20-25 mins)</strong>
                <ul class='ps-3'>
                  <li>Show of hands: How many have used herbal remedies for blood pressure?</li>
                  <li>For those who have: What made you decide to try herbal medicine?</li>
                  <li>What herbs or remedies have you used? Did they help?</li>
                  <li>Do any of you use both hospital medicine and herbs? How do you manage both?</li>
                  <li>Have you told your doctor about using herbs? Why or why not? What happened when you did?</li>
                  <li>Do you trust herbal remedies? Hospital medicines? Both? Neither? Why?</li>
                  <li>If you could have a system that combined the best of both approaches safely, would you want that?</li>
                </ul>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>E. SUPPORT & SELF-MANAGEMENT (15-20 mins)</strong>
                <ul class='ps-3'>
                  <li>Who helps you manage your blood pressure? (Family, friends, community?)</li>
                  <li>Do you monitor your BP at home? Why or why not?</li>
                  <li>How do you know if your treatment is working?</li>
                  <li>What information or education have you received? Was it helpful?</li>
                  <li>What support do you wish you had that you don't have now?</li>
                </ul>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>F. TECHNOLOGY & INNOVATION (10-15 mins)</strong>
                <ul class='ps-3'>
                  <li>Who has a smartphone? What do you use it for?</li>
                  <li>Would you be interested in an app that:
                    <ul>
                      <li>Reminds you to take medication?</li>
                      <li>Tracks your blood pressure?</li>
                      <li>Connects you with healthcare providers?</li>
                      <li>Provides health information?</li>
                    </ul>
                  </li>
                  <li>What would make it easy to use? What would make it hard?</li>
                  <li>Would you want to connect with other patients for support?</li>
                </ul>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>G. CLOSING REFLECTIONS (5-10 mins)</strong>
                <ul class='ps-3'>
                  <li>What's been most helpful about today's discussion?</li>
                  <li>If you could give advice to someone newly diagnosed, what would you say?</li>
                  <li>What's the one change that would most help you manage your blood pressure better?</li>
                  <li>Any final thoughts or questions?</li>
                </ul>
              </div>
              <p class='text-muted small mt-3'><i class='bi bi-clock me-1'></i>Total estimated time: 90-120 minutes</p>
              <p class='text-info small'><i class='bi bi-info-circle me-1'></i><strong>Facilitation Tips:</strong> Create supportive atmosphere, validate experiences, encourage peer-to-peer sharing, watch for emotional moments, have tissues available.</p>`,

            clinician: `<h6 class='guide-title text-accent mb-3'><i class='bi bi-hospital me-2'></i>Clinician Focus Group Discussion Guide</h6>
              <p class='text-muted mb-3'><strong>Participants:</strong> 6-10 healthcare providers (doctors, nurses, pharmacists, CHOs)</p>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>A. INTRODUCTION & CONTEXT SETTING (10 mins)</strong>
                <ul class='ps-3'>
                  <li>Introductions: name, role, facility, years of experience</li>
                  <li>Purpose: explore challenges and opportunities in hypertension management</li>
                  <li>Ground rules: professional dialogue, learn from each other</li>
                </ul>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>B. CLINICAL PRACTICE CHALLENGES (20-25 mins)</strong>
                <ul class='ps-3'>
                  <li>What are the biggest challenges you face in managing hypertensive patients?
                    <ul>
                      <li>At the patient level?</li>
                      <li>At the facility/system level?</li>
                      <li>At the policy level?</li>
                    </ul>
                  </li>
                  <li>Let's discuss adherence: What patterns do you see? What factors contribute most?</li>
                  <li>How do you currently assess and support adherence in your practice?</li>
                  <li>What resources or tools do you need but don't have?</li>
                  <li>How do staff shortages and workload affect hypertension care?</li>
                </ul>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>C. MEDICATION ACCESS & AFFORDABILITY (15-20 mins)</strong>
                <ul class='ps-3'>
                  <li>What issues do you encounter with medication availability?</li>
                  <li>How do cost concerns affect your prescribing decisions?</li>
                  <li>What happens when patients can't afford medications?</li>
                  <li>What solutions have you seen work?</li>
                </ul>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>D. HERBAL MEDICINE & INTEGRATION (25-30 mins)</strong>
                <ul class='ps-3'>
                  <li>In your practice, how common is concurrent use of herbal and conventional treatments?</li>
                  <li>How comfortable are you discussing herbal medicine with patients?</li>
                  <li>What training have you received on traditional medicine?</li>
                  <li>Share specific cases:
                    <ul>
                      <li>Have you seen positive outcomes from combined use?</li>
                      <li>Have you seen adverse interactions or negative outcomes?</li>
                    </ul>
                  </li>
                  <li>What is your professional stance on integration?
                    <ul>
                      <li>What are the potential benefits?</li>
                      <li>What are your concerns?</li>
                      <li>What safeguards would be needed?</li>
                    </ul>
                  </li>
                  <li>What would make you comfortable working with herbal practitioners?</li>
                  <li>What would a functional collaboration model look like?</li>
                  <li>What about regulatory and liability issues?</li>
                </ul>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>E. DIGITAL HEALTH & DATA SYSTEMS (15-20 mins)</strong>
                <ul class='ps-3'>
                  <li>What digital tools do you currently use in practice?</li>
                  <li>What are your experiences with EHR/EMR systems?</li>
                  <li>How could digital platforms improve hypertension management?</li>
                  <li>What features would be most useful in a clinical decision support tool?</li>
                  <li>How could technology facilitate care coordination and patient monitoring?</li>
                  <li>What barriers exist to digital health adoption in your setting?</li>
                  <li>How could digital tools help with the integration question?</li>
                </ul>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>F. PROFESSIONAL DEVELOPMENT & SUPPORT (10-15 mins)</strong>
                <ul class='ps-3'>
                  <li>What continuing education or training would be most valuable?</li>
                  <li>What support do you need from management/administration?</li>
                  <li>How can we better support healthcare workers in NCD management?</li>
                </ul>
              </div>
              <div class='guide-section mb-3'>
                <strong class='d-block mb-2'>G. SYSTEM CHANGE & RECOMMENDATIONS (10-15 mins)</strong>
                <ul class='ps-3'>
                  <li>If you could redesign hypertension care in your facility, what would you change?</li>
                  <li>What policy changes are most needed?</li>
                  <li>What role should research play in improving practice?</li>
                  <li>Final thoughts on moving forward?</li>
                </ul>
              </div>
              <p class='text-muted small mt-3'><i class='bi bi-clock me-1'></i>Total estimated time: 90-120 minutes</p>
              <p class='text-info small'><i class='bi bi-info-circle me-1'></i><strong>Facilitation Tips:</strong> Encourage evidence-based discussion, probe for specific examples, balance skepticism with innovation, respect professional concerns.</p>`
          };
          App.$('fgdGuide').innerHTML = guides[type] || "<p class='text-muted'>Select a group type to load the discussion guide.</p>";
        },

        save: (mode) => {
          const notes = mode === 'idi' ? App.$('idiNotes').value : App.$('fgdNotes').value;
          const pid = mode === 'idi' ? App.$('idiParticipantSelect').value : "FGD_GROUP";

          if (!notes && !pid) return alert("Select participant and add notes.");

          const record = {
            id: `INT-${Date.now()}`,
            mode: mode,
            participantId: pid,
            notes: notes,
            date: new Date().toISOString(),
            module: 'toolkit-a',
            type: 'toolkit-a-interview'
          };

          App.State.interviews.push(record);

          // Save to Unified DB
          db.upsert('toolkit', record).then(() => {
            console.log('âœ… Interview saved to IDB');
          }).catch(err => console.error('âŒ Failed to save interview to IDB', err));

          App.Storage.save();
          App.Toast("Interview Saved!");
        },

        complete: (mode) => {
          App.Interview.save(mode);
          if (mode === 'idi') {
            App.$('idiNotes').value = '';
            App.$('idiParticipantSelect').value = '';
          } else {
            App.$('fgdNotes').value = '';
          }
        }
      },

      Audio: {
        mediaRecorder: null,
        chunks: [],

        toggle: async (mode) => {
          const btn = App.$(mode === 'idi' ? 'btnRecIdi' : 'btnRecFgd');
          const status = App.$(mode === 'idi' ? 'statusIdi' : 'statusFgd');
          const pauseBtn = App.$(mode === 'idi' ? 'btnPauseIdi' : 'btnPauseFgd');

          if (btn.classList.contains('recording')) {
            App.Audio.mediaRecorder.stop();
            btn.classList.remove('recording', 'btn-danger');
            btn.classList.add('btn-success');
            btn.innerHTML = '<i class="bi bi-record-circle"></i> Record';
            status.textContent = "Processing...";
            pauseBtn.disabled = true;
          } else {
            try {
              const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
              App.Audio.mediaRecorder = new MediaRecorder(stream);
              App.Audio.chunks = [];

              App.Audio.mediaRecorder.ondataavailable = e => App.Audio.chunks.push(e.data);
              App.Audio.mediaRecorder.onstop = () => App.Audio.saveRecording(mode);

              App.Audio.mediaRecorder.start();

              btn.classList.add('recording');
              btn.classList.remove('btn-success');
              btn.classList.add('btn-danger');
              btn.innerHTML = '<i class="bi bi-stop-circle"></i> Stop';
              status.innerHTML = '<span class="text-danger blink">â— Recording...</span>';
              pauseBtn.disabled = false;
            } catch (e) {
              alert("Microphone access denied.");
            }
          }
        },

        pause: (mode) => {
          const rec = App.Audio.mediaRecorder;
          const btn = App.$(mode === 'idi' ? 'btnPauseIdi' : 'btnPauseFgd');
          const status = App.$(mode === 'idi' ? 'statusIdi' : 'statusFgd');

          if (rec.state === "recording") {
            rec.pause();
            btn.innerHTML = '<i class="bi bi-play"></i>';
            status.textContent = "Paused";
          } else if (rec.state === "paused") {
            rec.resume();
            btn.innerHTML = '<i class="bi bi-pause"></i>';
            status.innerHTML = '<span class="text-danger blink">â— Recording...</span>';
          }
        },

        saveRecording: async (mode) => {
          const blob = new Blob(App.Audio.chunks, { type: 'audio/webm' });

          const player = App.$(mode === 'idi' ? 'playerIdi' : 'playerFgd');
          const statusEl = App.$(mode === 'idi' ? 'statusIdi' : 'statusFgd');
          statusEl.textContent = "Saving...";

          const participantId = mode === 'idi' ? App.$('idiParticipantSelect').value : 'FGD';

          // Get participant details for naming
          let site = 'UNKNOWN';
          let participantName = participantId;
          if (mode === 'idi' && participantId) {
            const participant = App.State.participants.find(p => p.id === participantId);
            if (participant) {
              site = participant.site ? participant.site.replace(/\s+/g, '_').substring(0, 20) : 'UNKNOWN';
              participantName = participant.id;
            }
          }

          const dateStr = new Date().toISOString().split('T')[0];
          const timeStr = new Date().toISOString().split('T')[1].split('.')[0].replace(/:/g, '-');
          const id = `${participantName}_${site}_${dateStr}_${timeStr}`;

          // Setup audio player with proper event handlers
          player.style.display = 'block';
          player.controls = true;
          player.preload = 'metadata';

          // Prepare the blob URL for playback
          const url = URL.createObjectURL(blob);
          player.src = url;
          player.type = 'audio/webm';

          // Set up event handlers for playback feedback
          player.oncanplay = () => {
            console.log('âœ… Audio ready to play');
            statusEl.innerHTML = '<span class="text-success">Saved! Ready to play</span>';
          };

          player.onerror = (e) => {
            console.error('Audio playback error:', e);
            statusEl.innerHTML = '<span class="text-warning">Saved (playback unavailable)</span>';
          };

          player.onplay = () => {
            statusEl.innerHTML = '<span class="text-success">â–¶ Playing</span>';
          };

          player.onpause = () => {
            statusEl.innerHTML = '<span class="text-success">Saved! â¸ Paused</span>';
          };

          // Store blob in IndexedDB for persistence
          try {
            await App.AudioDB.saveBlob(id, blob, {
              mode,
              participantId,
              date: new Date().toISOString()
            });
            console.log('âœ… Audio saved to IndexedDB:', id);
          } catch (err) {
            console.error('Failed to save audio to IndexedDB:', err);
          }

          // Also keep in memory for immediate access
          App.State.audioBlobs[id] = blob;
          const recordingData = {
            id: id,
            mode: mode,
            date: new Date().toISOString(),
            participantId: participantId
          };
          App.State.audioRecordings.push(recordingData);
          App.Storage.save();

          // Save to unified database for synchronization
          try {
            if (typeof db !== 'undefined') {
              await UhasIDB.put('interviews', {
                module: 'toolkit-a',
                type: 'audio-recording',
                participantId: participantId,
                data: {
                  recordingId: id,
                  mode: mode,
                  date: new Date().toISOString(),
                  participantId: participantId,
                  status: 'completed',
                  hasAudioBlob: true
                }
              });
              console.log('âœ… Audio metadata saved to unified database');
            }
          } catch (err) {
            console.error('Failed to save to unified database:', err);
          }

          App.$(mode === 'idi' ? 'statusIdi' : 'statusFgd').textContent = "Saved!";
          App.Toast("Audio Recorded & Saved locally!");

          // Attempt background upload
          if (navigator.onLine) {
            App.Data.uploadAudio(id, true); // true = silent mode
          }
        }
      },

      Participants: {
        render: () => {
          const list = App.$('participantsList');
          const term = App.$('partSearch').value.toLowerCase();
          const countBadge = App.$('listCount');

          const filtered = App.State.participants.filter(p =>
            p.name.toLowerCase().includes(term) || p.id.toLowerCase().includes(term)
          );

          countBadge.textContent = filtered.length;

          if (filtered.length === 0) {
            list.innerHTML = '<div class="text-center p-4 text-muted"><i class="bi bi-search" style="font-size: 2rem; opacity: 0.5;"></i><p class="mt-2">No participants found.</p></div>';
            return;
          }

          list.innerHTML = filtered.map(p => `
            <div class="participant-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1">${p.name} <small class="text-muted ms-1">${p.id}</small></h6>
                  <div class="small text-muted">
                    <span class="text-uppercase" style="border-right: 1px solid var(--border); padding-right: 0.5rem; margin-right: 0.5rem;">${p.type}</span>
                    <span>${p.gender}, ${p.age}</span>
                  </div>
                </div>
                <div class="text-end">
                  <div class="mb-1">
                    <span class="status-badge ${p.isEligible ? 'status-eligible' : 'status-not-eligible'}">
                      ${p.isEligible ? 'Eligible' : 'Ineligible'}
                    </span>
                  </div>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline" title="Edit" onclick="App.Participants.edit('${p.id}')">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline" style="color: var(--danger);" title="Delete" onclick="App.Participants.delete('${p.id}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `).join('');
        },

        save: () => {
          const safeState = {
            participants: App.State.participants,
            interviews: App.State.interviews,
            audioRecordings: App.State.audioRecordings.map(r => ({ ...r, blob: null, url: null }))
          };
          localStorage.setItem('toolkit_a_data', JSON.stringify(safeState));
          App.Dashboard.update();
        },
        load: () => {
          const raw = localStorage.getItem('toolkit_a_data');
          if (raw) {
            const data = JSON.parse(raw);
            App.State.participants = data.participants || [];
            App.State.interviews = data.interviews || [];
            App.State.audioRecordings = data.audioRecordings || [];
          }
        }
      },
      Data: {
        downloadCSV: (type) => {
          let csv = "";
          if (type === 'participants') {
            csv = "ID,Name,Type,Gender,Age,Eligible,Site,Date\n" +
              App.State.participants.map(p =>
                `${p.id},"${p.name}",${p.type},${p.gender},${p.age},${p.isEligible},"${p.site}",${p.date}`
              ).join("\n");
          } else {
            csv = "ID,Mode,Participant,Notes,Date\n" +
              App.State.interviews.map(i =>
                `${i.id},${i.mode},${i.participantId},"${(i.notes || '').replace(/"/g, '""')}",${i.date}`
              ).join("\n");
          }

          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `toolkit_${type}_${Date.now()}.csv`;
          a.click();
        },

        downloadJSON: () => {
          const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(App.State));
          const a = document.createElement('a');
          a.href = dataStr;
          a.download = `toolkit_backup_${Date.now()}.json`;
          a.click();
        },

        importJSON: (input) => {
          const file = input.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = JSON.parse(e.target.result);
              App.State.participants = data.participants || [];
              App.State.interviews = data.interviews || [];
              App.Storage.save();
              alert("Data Imported Successfully! Reloading...");
              location.reload();
            } catch (err) {
              alert("Invalid JSON file");
            }
          };
          reader.readAsText(file);
        },

        // NEW: Render Data Tables
        currentTable: 'participants',

        switchTable: (type) => {
          App.Data.currentTable = type;

          // Update tabs
          document.querySelectorAll('#dataTabs .nav-link').forEach(el => el.classList.remove('active'));
          event.target.classList.add('active');

          if (type === 'audio') {
            App.$('dataTable').classList.add('d-none');
            App.$('audioListContainer').classList.remove('d-none');
            App.Data.renderAudioList();
          } else {
            App.$('dataTable').classList.remove('d-none');
            App.$('audioListContainer').classList.add('d-none');
            App.Data.renderTable();
          }
        },

        renderTable: async () => {
          const tbody = App.$('dataList');
          tbody.innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';

          let data = [];
          if (App.Data.currentTable === 'participants') {
            // Fetch from DB to ensure we show everything
            data = await UhasIDB.getAll('participants');
            if (data.length === 0) data = App.State.participants; // Fallback
          } else {
            data = await UhasIDB.getAll('interviews');
            if (data.length === 0) data = App.State.interviews; // Fallback
          }

          if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No records found.</td></tr>';
            return;
          }

          tbody.innerHTML = data.map(row => {
            const id = row.id || row.localId;
            const type = App.Data.currentTable === 'participants' ? row.type : row.mode;
            const date = new Date(row.date || row.createdAt).toLocaleDateString();
            // Check sync status if we had access to it, simplified for now
            const isSynced = false; // logic to check sync status from db metadata?

            return `
                    <tr>
                        <td>${id}</td>
                        <td><span class="badge bg-secondary">${type}</span></td>
                        <td>${date}</td>
                        <td>${isSynced ? '<span class="badge bg-success">Synced</span>' : '<span class="badge bg-warning text-dark">Local</span>'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="alert('Details view coming soon')"><i class="bi bi-eye"></i></button>
                        </td>
                    </tr>
                 `;
          }).join('');
        },

        syncNow: async () => {
          App.Toast("ðŸ“± All data is stored locally on your device. Export and send to WhatsApp to share.");
        },

        renderAudioList: async () => {
          const container = App.$('audioList');
          if (App.State.audioRecordings.length === 0) {
            container.innerHTML = '<div class="text-center p-3 text-muted">No recordings yet.</div>';
            return;
          }

          // Check which blobs are available in IndexedDB
          const storedBlobs = await App.AudioDB.getAllBlobs();
          const storedIds = new Set(storedBlobs.map(b => b.id));

          container.innerHTML = App.State.audioRecordings.map(r => {
            const hasBlob = App.State.audioBlobs[r.id] || storedIds.has(r.id);
            const dbRecord = storedBlobs.find(b => b.id === r.id);
            const isSynced = dbRecord?.synced;

            // Extract clean display name: remove time component from id
            const parts = r.id.split('_');
            const cleanName = parts.slice(0, -1).join('_');

            return `
            <div class="d-flex justify-content-between align-items-center p-2 mb-2" style="background: var(--bg-alt); border-radius: var(--radius-sm);">
              <div>
                <strong>${r.mode.toUpperCase()}</strong><br><span class="text-muted" style="font-family: monospace; font-size: 0.85rem;">${cleanName}.webm</span>
                <br><small class="text-muted">${new Date(r.date).toLocaleString()}</small>
                ${isSynced ? '<br><span class="badge" style="background: var(--success); color: white; font-size: 0.65rem;">Synced to Cloud</span>' : ''}
              </div>
              <div class="d-flex gap-1">
                ${hasBlob ?
                `<button class="btn btn-outline btn-sm" onclick="App.Data.downloadAudio('${r.id}')" title="Download">
                    <i class="bi bi-download"></i>
                  </button>` :
                `<span class="badge" style="background: var(--bg-alt);">Not available</span>`
              }
                ${hasBlob && !isSynced ?
                `<button class="btn btn-primary btn-sm" onclick="App.Data.uploadAudio('${r.id}')" title="Upload to Cloud">
                    <i class="bi bi-cloud-upload"></i>
                  </button>` : ''
              }
              </div>
            </div>`;
          }).join('');
        },

        downloadAudio: async (id) => {
          // First try memory, then IndexedDB
          let blob = App.State.audioBlobs[id];

          if (!blob) {
            try {
              const record = await App.AudioDB.getBlob(id);
              if (record) blob = record.blob;
            } catch (err) {
              console.error('Failed to get audio from IndexedDB:', err);
            }
          }

          if (!blob) return alert("Audio file not available.");

          // Extract download name: remove time component from id
          // ID format: ParticipantID_Site_Date_Time
          // Download format: ParticipantID_Site_Date
          const parts = id.split('_');
          // Remove last part (time) to get clean filename
          const downloadName = parts.slice(0, -1).join('_');

          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${downloadName}.webm`;
          a.click();
          URL.revokeObjectURL(url);

          console.log(`âœ… Downloaded: ${downloadName}.webm`);
        },

        uploadAudio: async (id, silent = false) => {
          if (!navigator.onLine) {
            if (!silent) App.Toast('You are offline. Try again when connected.');
            return;
          }

          // Get blob from memory or IndexedDB
          let blob = App.State.audioBlobs[id];
          if (!blob) {
            try {
              const record = await App.AudioDB.getBlob(id);
              if (record) blob = record.blob;
            } catch (err) {
              console.error('Failed to get audio from IndexedDB:', err);
            }
          }

          if (!blob) {
            if (!silent) alert("Audio file not available.");
            return;
          }

          try {
            if (!silent) App.Toast('ðŸ“± Data stored locally. Export and send via WhatsApp.');
            // All data is stored locally in IndexedDB
            // Users can export audio and send manually
          } catch (error) {
            console.error('Error:', error);
            if (!silent) App.Toast('Data is stored locally on your device.');
          }
        },

        uploadAllAudio: async () => {
          if (!navigator.onLine) {
            App.Toast('You are offline. Try again when connected.');
            return;
          }

          const storedBlobs = await App.AudioDB.getAllBlobs();
          const unsynced = storedBlobs.filter(b => !b.synced);

          if (unsynced.length === 0) {
            App.Toast('All audio files already synced!');
            return;
          }

          App.Toast(`Uploading ${unsynced.length} audio file(s)...`);

          let success = 0;
          let failed = 0;

          for (const record of unsynced) {
            try {
              await App.Data.uploadAudio(record.id);
              success++;
            } catch (err) {
              failed++;
              console.error(`Failed to upload ${record.id}:`, err);
            }
          }

          App.Toast(`Uploaded ${success}/${unsynced.length} files`);
          App.Data.renderAudioList();
        },

        clearAll: () => {
          if (confirm("Are you sure? This deletes everything including audio files.")) {
            // Clear IndexedDB audio
            localStorage.removeItem('toolkit_a_data');
            App.State.participants = [];
            App.State.interviews = [];
            App.State.audioRecordings = [];
            App.State.audioBlobs = {};
            App.Storage.save();
            App.Dashboard.update();
            App.Toast('All data cleared!');
          }
        }
      }
    };

    // Initialize the application
    window.addEventListener('DOMContentLoaded', () => {
      App.init();
    });
  </script>

  <!-- Firebase Services and Sync -->
  <script type="module">
    console.log('âœ… UHAS Toolkit A - Complete Offline Mode');
  </script>

  <!-- IndexedDB & Import/Export Management -->
  <script src="./assets/js/idb-manager.js"></script>
  <script src="./assets/js/import-export.js"></script>

  <!-- Core Database & Participant Scripts -->
  <script src="./assets/js/config.js"></script>
  <script src="./assets/js/participant.js"></script>
  
  <!-- Main App Script -->
  <script src="./app.js"></script>

  <!-- Service Worker Auto-Updater -->
  <script src="./assets/js/sw-updater.js"></script>
</body>

</html>